<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Buyer Account - MarketMix</title>
  <link rel="stylesheet" href="buyers profile .css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- üîí BLOCK UNAUTHORIZED USERS -->
  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.replace("login for buyers.html");
    }
  </script>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <button class="back-btn" onclick="history.back()">
    <i class="fas fa-chevron-left"></i> Back
  </button>
  
  <div class="profile-container">
    <h2>My Account</h2>

    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <!-- Profile Card -->
    <div class="profile-card">
      <img id="profileImage" src="elon.jfif" alt="Buyer Image">
      <div class="info">
        <p><strong>Name:</strong> <span id="userName">Loading...</span></p>
        <p><strong>Email:</strong> <span id="userEmail">Loading...</span></p>
        <p>
          <strong>Phone:</strong> 
          <!-- ‚úÖ FIXED: Removed nested span structure -->
          <span id="phoneDisplay">
            <span id="phoneNumber">Loading...</span>
          </span>
          <div id="phoneInputContainer" style="display: none;">
            <div class="phone-input-group">
              <input 
                type="tel" 
                id="phoneInput" 
                placeholder="+234 812 345 6789"
                pattern="[0-9+\s\-()]+"
                maxlength="20"
              />
              <button id="savePhoneBtn" class="btn-save-phone">
                <i class="fas fa-check"></i> Save
              </button>
              <button class="btn-add-phone" onclick="cancelPhoneInput()">Cancel</button>
            </div>
          </div>
        </p>
        <p><strong>Member Since:</strong> <span id="memberSince">Loading...</span></p>
      </div>
    </div>

    <!-- Navigation Links -->
    <div class="account-links">
      <a href="cart.html" class="link-card"><i class="fa-solid fa-cart-shopping"></i> Cart</a>
      <a href="buyers wishlist.html" class="link-card"><i class="fa-solid fa-heart"></i> Wishlist</a>
      <a href="buyers order & tracking.html" class="link-card"><i class="fa-solid fa-box"></i> Order Tracking</a>
      <a href="shipping infor.html" class="link-card"><i class="fa-solid fa-truck"></i> Shipping Info</a>
      <a href="save payment.html" class="link-card"><i class="fa-solid fa-credit-card"></i> saved payment methods</a>
      <a href="purchase history.html" class="link-card"><i class="fa-solid fa-receipt"></i> Purchase History</a>
      <a href="reviews ratings.html" class="link-card"><i class="fa-solid fa-star"></i> Reviews & Ratings</a>
      <a href="account setting.html" class="link-card"><i class="fa-solid fa-gear"></i> Account Settings</a>
      <a href="logout.html" class="link-card"><i class="fa fa-sign-out" aria-hidden="true"></i> logout</a>
    </div>
  </div>

  <footer>
    ¬© MarketMix 2025
  </footer>

  <script>
    // =====================================================
    // CONFIGURATION
    // =====================================================
    const API_BASE_URL = 'https://marketmix-backend.onrender.com/api';

    // =====================================================
    // LOAD USER PROFILE ON PAGE LOAD
    // =====================================================
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üìÑ Loading buyer profile...');
      await loadUserProfile();
      setupPhoneClickHandler();
    });

    async function loadUserProfile() {
      try {
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        // Hide loading overlay
        document.getElementById('loadingOverlay').style.display = 'none';

        // Populate user data from localStorage first (for instant display)
        if (user.firstName && user.lastName) {
          document.getElementById('userName').textContent = `${user.firstName} ${user.lastName}`;
        }
        if (user.email) {
          document.getElementById('userEmail').textContent = user.email;
        }

        // Handle phone number
        if (user.phone) {
          document.getElementById('phoneNumber').textContent = user.phone;
        } else {
          document.getElementById('phoneNumber').textContent = 'Not added yet';
        }

        // Format member since date
        if (user.createdAt) {
          const date = new Date(user.createdAt);
          const options = { year: 'numeric', month: 'long', day: 'numeric' };
          document.getElementById('memberSince').textContent = date.toLocaleDateString('en-US', options);
        } else {
          document.getElementById('memberSince').textContent = 'Recently';
        }

        // Fetch fresh data from backend
        console.log('üîÑ Fetching fresh user data from backend...');
        const response = await fetch(`${API_BASE_URL}/auth/me`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ Fresh user data received:', data);

          if (data.status === 'success' && data.data.user) {
            const freshUser = data.data.user;
            
            // Update localStorage with fresh data
            localStorage.setItem('user', JSON.stringify(freshUser));

            // Update UI with fresh data
            document.getElementById('userName').textContent = `${freshUser.firstName} ${freshUser.lastName}`;
            document.getElementById('userEmail').textContent = freshUser.email;

            // Update phone display
            if (freshUser.phone) {
              document.getElementById('phoneNumber').textContent = freshUser.phone;
            } else {
              document.getElementById('phoneNumber').textContent = 'Not added yet';
            }

            if (freshUser.createdAt) {
              const date = new Date(freshUser.createdAt);
              const options = { year: 'numeric', month: 'long', day: 'numeric' };
              document.getElementById('memberSince').textContent = date.toLocaleDateString('en-US', options);
            }
          }
        } else {
          console.warn('‚ö†Ô∏è Could not fetch fresh data, using cached data');
        }

      } catch (error) {
        console.error('‚ùå Error loading profile:', error);
        document.getElementById('loadingOverlay').style.display = 'none';
        showAlert('error', 'Could not load profile data');
      }
    }

    // =====================================================
    // PHONE NUMBER MANAGEMENT - ‚úÖ FIXED!
    // =====================================================
    function setupPhoneClickHandler() {
      const phoneDisplay = document.getElementById('phoneDisplay');
      if (phoneDisplay) {
        phoneDisplay.addEventListener('click', function() {
          const phoneNumber = document.getElementById('phoneNumber').textContent;
          if (phoneNumber && phoneNumber !== 'Not added yet' && phoneNumber !== 'Loading...') {
            document.getElementById('phoneInput').value = phoneNumber;
          }
          showPhoneInput();
        });
      }

      // Setup save button
      const saveBtn = document.getElementById('savePhoneBtn');
      if (saveBtn) {
        saveBtn.addEventListener('click', savePhoneNumber);
      }

      // Setup input validation
      const phoneInput = document.getElementById('phoneInput');
      if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
          this.value = this.value.replace(/[^0-9+\s\-()]/g, '');
        });

        phoneInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            savePhoneNumber();
          }
        });
      }
    }

    function showPhoneInput() {
      console.log('üîÑ Showing phone input...');
      document.getElementById('phoneDisplay').style.display = 'none';
      document.getElementById('phoneInputContainer').style.display = 'block';
      document.getElementById('phoneInput').focus();
    }

    function cancelPhoneInput() {
      console.log('‚ùå Canceling phone input...');
      document.getElementById('phoneDisplay').style.display = 'inline';
      document.getElementById('phoneInputContainer').style.display = 'none';
      document.getElementById('phoneInput').value = '';
    }

    async function savePhoneNumber() {
      const phoneInput = document.getElementById('phoneInput');
      const phone = phoneInput.value.trim();

      // Validate phone number
      if (!phone) {
        showAlert('error', 'Please enter a phone number');
        return;
      }

      if (phone.length < 10) {
        showAlert('error', 'Please enter a valid phone number');
        return;
      }

      console.log('üìû Saving phone number:', phone);

      const saveBtn = document.getElementById('savePhoneBtn');

      try {
        const token = localStorage.getItem('token');

        // Show loading state
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-small"></span> Saving...';

        const response = await fetch(`${API_BASE_URL}/auth/update-phone`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ phone })
        });

        const data = await response.json();

        if (response.ok && data.status === 'success') {
          console.log('‚úÖ Phone number saved successfully');

          // Update localStorage
          const user = JSON.parse(localStorage.getItem('user') || '{}');
          user.phone = phone;
          localStorage.setItem('user', JSON.stringify(user));

          // Update UI - display the new phone number
          document.getElementById('phoneNumber').textContent = phone;

          // üî• HIDE INPUT & SHOW THE PHONE TEXT AGAIN
          console.log('üîÑ Hiding input, showing display...');
          document.getElementById('phoneDisplay').style.display = 'inline';
          document.getElementById('phoneInputContainer').style.display = 'none';
          document.getElementById('phoneInput').value = '';

          // Show success message
          showAlert('success', 'Phone number saved successfully!');

        } else {
          throw new Error(data.message || 'Failed to save phone number');
        }

      } catch (error) {
        console.error('‚ùå Error saving phone:', error);
        showAlert('error', error.message || 'Could not save phone number. Please try again.');
      } finally {
        // Reset button state
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-check"></i> Save';
      }
    }

    // =====================================================
    // ALERT FUNCTIONS
    // =====================================================
    function showAlert(type, message) {
      const alertContainer = document.getElementById('alertContainer');
      
      // Remove existing alerts
      alertContainer.innerHTML = '';

      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
      `;

      alertContainer.appendChild(alert);

      // Auto-remove after 5 seconds
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }
  </script>
</body>
</html>