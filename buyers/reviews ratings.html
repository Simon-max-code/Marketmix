<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
 <!-- üîí BLOCK UNAUTHORIZED USERS -->
    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.replace("login.html");
        }
    </script>
<title>My Reviews ‚Äî MarketMix (Buyer)</title>

<style>
 :root {
  --bg:   #FFF7ED;
  --card:#ffffff;
  --border: #e0e0e0;
  --muted: #666;
  --accent:  #F97316;
  --gold: #d1c323;
  --success: #38a169;
  --danger: #e53e3e;
  --maxw: 1000px;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
  background: #FFF7ED;
  color: #222;
  line-height: 1.6;
}

.wrap {
  max-width: var(--maxw);
  margin: 32px auto;
  padding: 20px;
}

h1 {
  text-align: center;
  margin-bottom: 24px;
}

.grid {
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 20px;
}
@media (max-width: 920px) {
  .grid { grid-template-columns: 1fr; }
}

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 18px;
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);

}


.review {
  display: flex;
  gap: 14px;
  padding: 14px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: var(--card);
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

/* Alternate backgrounds for visual variety */
.review:nth-child(odd) {
  background: #f5ecd1; /* soft cream, matches warm gradient */
}

.review:nth-child(even) {
  background: #f5ecd1; /* light blue tint */
}

/* Sentiment-based backgrounds */
.review.good {
  background: #61ba79; /* light green, matches var(--success) */
}

.review.neutral {
  background: #a4a08f; /* warm yellow tint */
}

.review.bad {
  background: #c36b6b; /* light red, matches var(--danger) */
}


.controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}
.controls select,
.controls input[type=search] {
  padding: 10px 12px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: #f5f5f5;
  font-size: 15px;
}
.controls input[type=search] {
  flex: 2;
  min-width: 240px;
}

.review-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.review {
  display: flex;
  gap: 14px;
  padding: 14px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: #fff;
}

.avatar {
  width: 50px;
  height: 50px;
  border-radius: 6px;
  background: #ada598;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: #555;
}

.stars {
  color: var(--gold);
}

.meta {
  font-size: 13px;
  color: var(--muted);
  margin-top: 4px;
}

.btn {
  background: var(--accent);
  color: #ffffff;
  padding: 8px 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  margin-right: 8px; /* spacing between buttons */
}
.btn:last-child {
  margin-right: 0; /* no extra gap after last button */
}
.btn:hover {
  background:  #EA580C;
}
.btn.ghost {
  background: #f2f2f2;
  color: #333;
}

textarea {
  width: 100%;
  min-height: 100px;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid var(--border);
  resize: vertical;
  font-size: 15px;
}

.media-row img,
.media-row video {
  border-radius: 6px;
  border: 1px solid var(--border);
}
.preview-area img,
.preview-area video {
  border-radius: 6px;
  border: 1px solid var(--border);
}

.toast {
  position: fixed;
  right: 5px;
  top: 20px;
  padding: 10px 14px;
  border-radius: 6px;
  color: #fff;
  z-index: 999;
  transform: translateX(120%);
  transition: transform .3s ease;
  font-size: 14px;
}
.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.show { transform: translateX(0); }



  /*footer*/
  footer {
  text-align: center;
  padding: 15px;
  background-color: #c7c7c7;
  color: #555;
  font-size: 14px;
  margin-top: 30px;
}




.navbar {
  background: var(--card);
  padding: 10px 20px;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.06);
  display: flex;
  gap: 20px;
  justify-content: center;
  position: relative;
  max-width: 800px;
  margin: 20px auto; /* center horizontally */
  border: 1px solid var(--border);
}

@media (max-width: 768px) {
  .navbar{
    background: var(--card);
  padding: 7px 15px;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.06);
  display: flex;
  gap: 20px;
  justify-content: center;
  position: relative;
  max-width: 400px;
  margin: 20px auto; /* center horizontally */
  margin-bottom: -33px;
  border: 1px solid var(--border);
  }
}

.navbar a {
  text-decoration: none;
  color: var(--accent);
  font-weight: 500;
  transition: color 0.2s ease;
}

.navbar a:hover {
  color: #1a4d80;
}



footer {
     background: rgba(0, 0, 0, 0.7);
      color: #f8fafc;
      text-align: center;
      padding: 25px 15px;
      margin-top: 60px;
      font-size: 15px;
    }



    .back-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #F97316; /* your site yellow theme */
  color: #000;
  border: none;
  padding: 10px 16px;
  border-radius: 10px;
  font-size: 16px;
  cursor: pointer;
  margin: 2px;
  transition: 0.3s;
}

.back-btn i {
  font-size: 18px;
}

.back-btn:hover {
  background: #EA580C;
  transform: translateY(-2px);
}
</style>
</head>
<body>




 <button class="back-btn" onclick="history.back()">
      <i class="fas fa-chevron-left"></i> Back
    </button>

  <div class="wrap">
    <h1>‚≠ê My Reviews (buyer)</h1>
    <div class="grid">
      <!-- LEFT: reviews + form -->
      <main>
        <div class="card" aria-labelledby="section-stats">
          <div class="controls" role="region" aria-label="filters">
            <select id="sortBy" title="Sort reviews">
              <option value="newest">Sort: Newest</option>
              <option value="oldest">Sort: Oldest</option>
              <option value="highest">Sort: Highest rating</option>
              <option value="lowest">Sort: Lowest rating</option>
            </select>
            <select id="filterStar" title="Filter by star">
              <option value="">All ratings</option>
              <option value="5">5‚òÖ</option>
              <option value="4">4‚òÖ</option>
              <option value="3">3‚òÖ</option>
              <option value="2">2‚òÖ</option>
              <option value="1">1‚òÖ</option>
            </select>
            <input type="search" id="q" placeholder="Search reviews..." style="flex:1" />
            <button id="clearAll" class="btn ghost">Clear</button>
          </div>

          <div id="reviewList" class="review-list" aria-live="polite"></div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3 id="formTitle">Leave a review (buyer)</h3>
          <div style="display:flex;gap:12px;align-items:center">
            <img src="home and kitchen.webp" alt="" style="width:64px;height:64px;object-fit:cover;border-radius:8px">
            <div>
              <strong id="productTitle">Classic Leather Bag</strong>
              <div class="small">Order # <input id="orderId" placeholder="e.g. MMX123456" style="border:none;background:transparent;outline:none;width:110px"/></div>
            </div>
          </div>

          <div style="margin-top:8px">
            <label class="small">Rating <span class="small muted">(required)</span></label>
            <div id="rateWidget" class="star-input" role="radiogroup" aria-label="Rating">
              <button  data-value="1" aria-label="1 star">‚òÖ</button>
              <button data-value="2" aria-label="2 stars">‚òÖ</button>
              <button data-value="3" aria-label="3 stars">‚òÖ</button>
              <button data-value="4" aria-label="4 stars">‚òÖ</button>
              <button data-value="5" aria-label="5 stars">‚òÖ</button>
            </div>
          </div>

          <textarea id="reviewText" placeholder="Share your experience..." maxlength="1200"></textarea>

          <div class="form-row">
            <input id="media" type="file" accept="image/*,video/*" multiple />
            <div class="small muted" id="charCnt">0 / 1200</div>
            <button id="submit" class="btn">Submit</button>
          </div>

          <div class="preview-area" id="previewArea" aria-live="polite"></div>
        </div>
      </main>

      <!-- RIGHT: summary + moderation demo -->
      <aside>
        <div class="card">
          <h4>Summary</h4>
          <div class="small muted">Average rating & counts (client-only)</div>
          <div style="margin-top:8px">
            <div style="font-size:28px;font-weight:700" id="avg">0.0</div>
            <div class="small muted" id="count">0 reviews</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Flags (demo)</h4>
          <div id="flags" class="small muted">No flagged reviews</div>
          <div style="margin-top:8px"><button id="clearFlags" class="btn ghost">Clear Flags</button></div>
        </div>
      </aside>
    </div>
  </div>

  <div id="toast" class="toast success" role="status" aria-live="polite">Saved</div>

<script>

  
/* Front-end buyer reviews w/ media saved to localStorage */
const STORAGE = 'mmx:buyer:reviews:v1';
const FLAGKEY = 'mmx:buyer:flags:v1';
const me = { id: 'you', name: 'You' };
const MAX_FILES = 3;
const MAX_IMAGE_BYTES = 5 * 1024 * 1024; // 5MB
const MAX_VIDEO_BYTES = 10 * 1024 * 1024; // 10MB

const sample = [
  { id:'r1', product:'Wireless Bluetooth Headset', orderId:'MMX0001', author:me, rating:5, body:'Great sound and battery life. Worth the price!', createdAt:'2025-06-01T10:00:00Z', verified:true, media:[], replies:[{by:'Seller',text:'Thanks! Glad you like it.',when:'2025-06-02T09:00:00Z'}] },
  { id:'r2', product:'Classic Leather Bag', orderId:'MMX123456', author:me, rating:4, body:'Very stylish and strong. My favorite purchase!', createdAt:'2025-05-20T12:00:00Z', verified:true, media:[], replies:[] }
];

function load(){
  try{
    const raw = localStorage.getItem(STORAGE);
    if(!raw){ localStorage.setItem(STORAGE, JSON.stringify(sample)); return sample.slice(); }
    return JSON.parse(raw);
  }catch(e){ return sample.slice(); }
}
function save(data){ localStorage.setItem(STORAGE, JSON.stringify(data)); render(); }
function flagsLoad(){ try{return JSON.parse(localStorage.getItem(FLAGKEY)||'[]');}catch(e){return []} }
function flagsSave(f){ localStorage.setItem(FLAGKEY, JSON.stringify(f)); renderFlags(); }

const reviewList = document.getElementById('reviewList');
const toastEl = document.getElementById('toast');
const previewArea = document.getElementById('previewArea');

function showToast(msg, type='success'){
  toastEl.textContent = msg;
  toastEl.className = 'toast ' + (type==='error' ? 'error' : 'success') + ' show';
  setTimeout(()=> toastEl.classList.remove('show'), 2600);
}

function computeStats(reviews){
  const count = reviews.length;
  const sum = reviews.reduce((s,r)=>s+r.rating,0);
  return {count, avg: count ? Math.round((sum/count)*10)/10 : 0};
}

function formatStars(n){ return '‚òÖ'.repeat(n) + '‚òÜ'.repeat(5-n); }
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* Render reviews including media */
function render(){
  const reviews = load();
  reviewList.innerHTML = '';
  const filter = document.getElementById('filterStar').value;
  const q = document.getElementById('q').value.trim().toLowerCase();
  const sortBy = document.getElementById('sortBy').value;

  let view = reviews.slice();
  if(filter) view = view.filter(r=> String(r.rating) === filter);
  if(q) view = view.filter(r=> (r.body + ' ' + r.product).toLowerCase().includes(q));
  if(sortBy === 'newest') view.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
  if(sortBy === 'oldest') view.sort((a,b)=> new Date(a.createdAt) - new Date(b.createdAt));
  if(sortBy === 'highest') view.sort((a,b)=> b.rating - a.rating);
  if(sortBy === 'lowest') view.sort((a,b)=> a.rating - b.rating);

  view.forEach(r => {
    const el = document.createElement('div'); el.className='review';
    let mediaHtml = '';
    if(r.media && r.media.length){
      mediaHtml = `<div class="media-row">`;
      r.media.forEach(m=>{
        if(m.type.startsWith('image')) mediaHtml += `<img src="${m.data}" alt="review image">`;
        else mediaHtml += `<video controls src="${m.data}"></video>`;
      });
      mediaHtml += `</div>`;
    }

    el.innerHTML = `
      <div class="left">
        <div class="avatar">${(r.author && r.author.name ? r.author.name[0] : 'U')}</div>
      </div>
      <div class="right">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <strong>${escapeHtml(r.product)}</strong>
            <div class="stars" aria-hidden="true">${formatStars(r.rating)}</div>
            <div class="meta">${new Date(r.createdAt).toLocaleString()} ${r.verified? ' ‚Ä¢ <span class="small muted">Verified</span>':''}</div>
          </div>
          <div style="text-align:right">
            ${r.author && r.author.id === me.id ? '<div class="tiny muted">You</div>' : ''}
            <div class="tiny muted">Order: ${escapeHtml(r.orderId||'‚Äî')}</div>
          </div>
        </div>
        <div style="margin-top:8px">${escapeHtml(r.body)}</div>
        ${mediaHtml}
        ${r.replies && r.replies.length ? `<div class="seller-reply"><strong>Seller:</strong> ${escapeHtml(r.replies[0].text)}</div>` : ''}
        <div class="actions">
          <button class="btn ghost" data-act="edit" data-id="${r.id}">Edit</button>
          <button class="btn ghost" data-act="delete" data-id="${r.id}">Delete</button>
          <button class="btn" data-act="reply" data-id="${r.id}">Mock seller reply</button>
          <button class="btn ghost tiny" data-act="flag" data-id="${r.id}">Flag</button>
        </div>
      </div>
    `;
    reviewList.appendChild(el);
  });

  // stats
  const stats = computeStats(reviews);
  document.getElementById('avg').textContent = stats.avg.toFixed(1);
  document.getElementById('count').textContent = `${stats.count} review${stats.count !== 1 ? 's' : ''}`;

  // wire actions
  reviewList.querySelectorAll('button').forEach(b=>{
    const act = b.dataset.act, id = b.dataset.id;
    b.addEventListener('click', ()=> {
      if(act === 'edit') startEdit(id);
      if(act === 'delete') deleteReview(id);
      if(act === 'reply') mockSellerReply(id);
      if(act === 'flag') flagReview(id);
    });
  });
  renderFlags();
}

/* CRUD actions (client-only) */
function addReview(obj){
  const reviews = load();
  reviews.unshift(obj);
  save(reviews);
  showToast('Review added');
}

function updateReview(id, patch){
  const reviews = load();
  const i = reviews.findIndex(r=> r.id === id);
  if(i === -1){ showToast('Review not found', 'error'); return; }
  reviews[i] = {...reviews[i], ...patch};
  save(reviews);
  showToast('Review updated');
}

function deleteReview(id){
  if(!confirm('Delete this review? This cannot be undone (client-only).')) return;
  const reviews = load().filter(r=> r.id !== id);
  save(reviews);
  showToast('Review deleted');
}

function mockSellerReply(id){
  const text = prompt('Write a mock seller reply (demo):','Thanks for the feedback ‚Äî we appreciate it!');
  if(!text) return;
  const when = new Date().toISOString();
  const reviews = load();
  const r = reviews.find(x=> x.id === id);
  if(r){ r.replies = r.replies || []; r.replies.unshift({by:'Seller', text, when}); save(reviews); showToast('Mock reply added'); }
}

function flagReview(id){
  const flags = flagsLoad();
  if(flags.includes(id)){ showToast('Already flagged', 'error'); return; }
  flags.push(id); flagsSave(flags); showToast('Flagged for moderation (demo)');
}

function renderFlags(){
  const flags = flagsLoad();
  document.getElementById('flags').textContent = flags.length ? flags.join(', ') : 'No flagged reviews';
}
document.getElementById('clearFlags').addEventListener('click', ()=> { localStorage.removeItem(FLAGKEY); renderFlags(); showToast('Flags cleared'); });

/* Edit flow: inline edit card (keeps media) */
let editingId = null;
function startEdit(id){
  if(editingId){ showToast('Finish the current edit first','error'); return; }
  const reviews = load(); const r = reviews.find(x=> x.id === id);
  if(!r) return;
  editingId = id;
  // fill form with review data (we reuse the main form)
  document.getElementById('formTitle').textContent = 'Edit your review';
  document.getElementById('productTitle').textContent = r.product || 'Product';
  document.getElementById('orderId').value = r.orderId || '';
  document.getElementById('reviewText').value = r.body || '';
  document.getElementById('charCnt').textContent = `${(r.body||'').length} / 1200`;
  // set stars
  selected = r.rating || 0;
  rateWidget.querySelectorAll('button').forEach(x=> x.classList.toggle('active', Number(x.dataset.value) <= selected));
  // preview existing media
  previewArea.innerHTML = '';
  if(r.media && r.media.length){
    r.media.forEach(m=>{
      if(m.type.startsWith('image')) {
        const img = document.createElement('img'); img.src = m.data; previewArea.appendChild(img);
      } else {
        const v = document.createElement('video'); v.src = m.data; v.controls = true; previewArea.appendChild(v);
      }
    });
  }
  // scroll to form
  window.scrollTo({top: document.querySelector('.card[style]').offsetTop - 20, behavior: 'smooth'});
}

/* Submit new review (or save edited one) */
const rateWidget = document.getElementById('rateWidget');
let selected = 0;
rateWidget.querySelectorAll('button').forEach(b=>{
  b.addEventListener('click', ()=> {
    selected = Number(b.dataset.value);
    rateWidget.querySelectorAll('button').forEach(x=> x.classList.toggle('active', Number(x.dataset.value) <= selected));
  });
});

document.getElementById('reviewText').addEventListener('input', e=>{
  document.getElementById('charCnt').textContent = `${e.target.value.length} / 1200`;
});

/* stagedFiles: hold data URLs before submit */
let stagedFiles = [];

/* handle file input change: validate and convert to dataURL(s) */
document.getElementById('media').addEventListener('change', async (e) => {
  const files = Array.from(e.target.files).slice(0, MAX_FILES);
  stagedFiles = [];
  previewArea.innerHTML = '';
  for(const f of files){
    // validate
    if(f.type.startsWith('image') && f.size > MAX_IMAGE_BYTES){ showToast('Image too large (max 5MB)', 'error'); continue; }
    if(f.type.startsWith('video') && f.size > MAX_VIDEO_BYTES){ showToast('Video too large (max 10MB)', 'error'); continue; }
    // read
    try{
      const data = await readFileAsDataURL(f);
      stagedFiles.push({type: f.type, data});
      if(f.type.startsWith('image')){
        const img = document.createElement('img'); img.src = data; previewArea.appendChild(img);
      } else {
        const vid = document.createElement('video'); vid.src = data; vid.controls = true; previewArea.appendChild(vid);
      }
    }catch(err){
      console.error(err);
      showToast('Error reading file', 'error');
    }
  }
});

/* helper to read file as data URL */
function readFileAsDataURL(file){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* new submit handler */
document.getElementById('submit').addEventListener('click', ()=>{
  const body = document.getElementById('reviewText').value.trim();
  const order = document.getElementById('orderId').value.trim();
  if(!selected){ showToast('Please select a rating','error'); return; }
  if(!body || body.length < 4){ showToast('Write a longer review','error'); return; }

  const reviews = load();
  if(editingId){
    // update existing
    const i = reviews.findIndex(r=> r.id === editingId);
    if(i === -1){ showToast('Editing target not found','error'); editingId = null; return; }
    // merge new staged files with existing media (keep existing if no new staged files)
    const existingMedia = reviews[i].media || [];
    const newMedia = stagedFiles.length ? stagedFiles.slice() : existingMedia.slice();
    reviews[i] = {...reviews[i], rating: selected, body, orderId: order || '', media: newMedia, editedAt: new Date().toISOString()};
    save(reviews);
    showToast('Review updated');
    editingId = null;
  } else {
    // create new
    const id = 'r'+Date.now();
    const newR = { id, product:'Classic Leather Bag', orderId: order || '', author: me, rating: selected, body, createdAt: new Date().toISOString(), verified: (order||'').toUpperCase().startsWith('MMX'), replies: [], media: stagedFiles.slice() };
    addReview(newR);
  }

  // reset form
  document.getElementById('reviewText').value = '';
  document.getElementById('orderId').value = '';
  selected = 0; rateWidget.querySelectorAll('button').forEach(x=> x.classList.remove('active'));
  document.getElementById('charCnt').textContent = '0 / 1200';
  stagedFiles = []; previewArea.innerHTML = '';
  document.getElementById('media').value = '';
});

/* helpers for edit/delete/etc */
function addReview(obj){
  const arr = load();
  arr.unshift(obj);
  save(arr);
}
function updateReview(id, patch){ updateReview; } // kept for API parity (not used directly)
function deleteReview(id){
  if(!confirm('Delete this review? This cannot be undone (client-only).')) return;
  const reviews = load().filter(r=> r.id !== id);
  save(reviews);
  showToast('Review deleted');
}
function updateReview(id, patch){
  const reviews = load();
  const idx = reviews.findIndex(r=> r.id === id);
  if(idx === -1){ showToast('Review not found','error'); return; }
  reviews[idx] = {...reviews[idx], ...patch};
  save(reviews);
  showToast('Review updated');
}

/* mock reply & flag */
function mockSellerReply(id){
  const text = prompt('Write a mock seller reply (demo):','Thanks for the feedback ‚Äî we appreciate it!');
  if(!text) return;
  const when = new Date().toISOString();
  const reviews = load();
  const r = reviews.find(x=> x.id === id);
  if(r){ r.replies = r.replies || []; r.replies.unshift({by:'Seller', text, when}); save(reviews); showToast('Mock reply added'); }
}
function flagReview(id){
  const flags = flagsLoad();
  if(flags.includes(id)){ showToast('Already flagged', 'error'); return; }
  flags.push(id); flagsSave(flags); showToast('Flagged for moderation (demo)');
}

/* additional helpers */
document.getElementById('filterStar').addEventListener('change', render);
document.getElementById('q').addEventListener('input', ()=> setTimeout(render, 200));
document.getElementById('sortBy').addEventListener('change', render);
document.getElementById('clearAll').addEventListener('click', ()=> { document.getElementById('filterStar').value=''; document.getElementById('q').value=''; document.getElementById('sortBy').value='newest'; render(); });

document.getElementById('clearFlags').addEventListener('click', ()=> { localStorage.removeItem(FLAGKEY); renderFlags(); showToast('Flags cleared'); });

/* initial render */
render();
</script>
<footer>
  ¬© MarketMix 2025
</footer>
</body>
</html>
