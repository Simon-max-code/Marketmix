<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script>
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.replace("login for buyers.html");
  }
</script>
<title>My Reviews ‚Äî MarketMix</title>

<style>
:root {
  --bg: #FFF7ED;
  --card: #ffffff;
  --border: #e0e0e0;
  --muted: #666;
  --accent: #F97316;
  --gold: #d1c323;
  --success: #38a169;
  --danger: #e53e3e;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
  background: #FFF7ED;
  color: #222;
  line-height: 1.6;
}

.wrap {
  max-width: 1200px;
  margin: 32px auto;
  padding: 20px;
}

h1 { text-align: center; margin-bottom: 24px; }

.grid {
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 20px;
}
@media (max-width: 920px) {
  .grid { grid-template-columns: 1fr; }
}

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 18px;
  box-shadow: 0 6px 12px rgba(0,0,0,0.08);
}

.controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

.controls select,
.controls input[type=search] {
  padding: 10px 12px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: #f5f5f5;
  font-size: 15px;
}

.controls input[type=search] {
  flex: 2;
  min-width: 240px;
}

.review-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.review {
  display: flex;
  gap: 14px;
  padding: 14px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: #fff;
  transition: box-shadow 0.2s;
  position: relative;
}

.review:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.review.editing {
  border: 2px solid var(--accent);
  background: #fff7ed;
}

.avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: #fff;
  flex-shrink: 0;
}

.stars { color: var(--gold); font-size: 18px; }

.meta {
  font-size: 13px;
  color: var(--muted);
  margin-top: 4px;
}

.btn {
  background: var(--accent);
  color: #fff;
  padding: 8px 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  margin-right: 8px;
  transition: all 0.2s;
}

.btn:hover { 
  background: #EA580C;
  transform: translateY(-1px);
}

.btn.ghost {
  background: #f2f2f2;
  color: #333;
}

.btn.ghost:hover {
  background: #e0e0e0;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.btn-danger {
  background: var(--danger);
}

.btn-danger:hover {
  background: #c53030;
}

.btn-success {
  background: var(--success);
}

.btn-success:hover {
  background: #2f855a;
}

textarea {
  width: 100%;
  min-height: 100px;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid var(--border);
  resize: vertical;
  font-size: 15px;
  font-family: inherit;
}

input[type="text"],
input[type="file"] {
  width: 100%;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid var(--border);
  font-size: 15px;
}

.toast {
  position: fixed;
  right: 20px;
  top: 20px;
  padding: 12px 20px;
  border-radius: 8px;
  color: #fff;
  z-index: 999;
  transform: translateX(120%);
  transition: transform .3s ease;
  font-size: 14px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.info { background: #3b82f6; }
.toast.show { transform: translateX(0); }

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.95);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid #f0f0f0;
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.back-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #F97316;
  color: #fff;
  border: none;
  padding: 10px 16px;
  border-radius: 10px;
  font-size: 16px;
  cursor: pointer;
  margin-bottom: 20px;
  transition: 0.3s;
}

.back-btn:hover {
  background: #EA580C;
  transform: translateY(-2px);
}

.star-input {
  display: flex;
  gap: 5px;
  margin: 10px 0;
}

.star-input button {
  background: none;
  border: none;
  font-size: 32px;
  color: #ddd;
  cursor: pointer;
  padding: 0;
  transition: color 0.2s, transform 0.2s;
}

.star-input button:hover {
  color: var(--gold);
  transform: scale(1.1);
}

.star-input button.active {
  color: var(--gold);
}

.media-preview {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 10px;
}

.media-preview-item {
  position: relative;
  width: 80px;
  height: 80px;
}

.media-preview img,
.media-preview video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 6px;
  border: 1px solid var(--border);
}

.media-preview-item button {
  position: absolute;
  top: -8px;
  right: -8px;
  background: var(--danger);
  color: white;
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
}

.review-media {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  flex-wrap: wrap;
}

.review-media img,
.review-media video {
  max-width: 150px;
  max-height: 150px;
  object-fit: cover;
  border-radius: 6px;
  border: 1px solid var(--border);
  cursor: pointer;
  transition: transform 0.2s;
}

.review-media img:hover,
.review-media video:hover {
  transform: scale(1.05);
}

.seller-reply {
  margin-top: 12px;
  padding: 10px;
  background: #f9f9f9;
  border-left: 3px solid var(--accent);
  border-radius: 4px;
  font-size: 14px;
}

footer {
  background: rgba(0, 0, 0, 0.7);
  color: #f8fafc;
  text-align: center;
  padding: 25px 15px;
  margin-top: 60px;
  font-size: 15px;
}

.empty-state {
  text-align: center;
  padding: 40px;
  color: var(--muted);
}

.verified-badge {
  display: inline-block;
  background: var(--success);
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 11px;
  margin-left: 8px;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal.show {
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: white;
  border-radius: 12px;
  padding: 24px;
  max-width: 600px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideUp 0.3s;
}

@keyframes slideUp {
  from { 
    opacity: 0;
    transform: translateY(20px);
  }
  to { 
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-header h2 {
  margin: 0;
  font-size: 24px;
}

.close-modal {
  background: none;
  border: none;
  font-size: 28px;
  cursor: pointer;
  color: var(--muted);
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  transition: background 0.2s;
}

.close-modal:hover {
  background: #f0f0f0;
}

.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
  font-size: 14px;
}

.form-group.required label::after {
  content: " *";
  color: var(--danger);
}

.small {
  font-size: 13px;
}

.muted {
  color: var(--muted);
}

.zoom-modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  align-items: center;
  justify-content: center;
}

.zoom-modal.show {
  display: flex;
}

.zoom-modal img,
.zoom-modal video {
  max-width: 90%;
  max-height: 90%;
  border-radius: 8px;
}

.zoom-close {
  position: absolute;
  top: 20px;
  right: 30px;
  color: white;
  font-size: 40px;
  cursor: pointer;
  background: none;
  border: none;
  padding: 0;
}

.badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
}

.badge-warning {
  background: #fef3c7;
  color: #92400e;
}

.badge-achievement {
  background: #dbeafe;
  color: #1e40af;
  margin: 2px;
}

.analytics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}

.stat-box {
  background: #f9fafb;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  border: 1px solid var(--border);
}

.stat-number {
  font-size: 24px;
  font-weight: 700;
  color: var(--accent);
}

.stat-label {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
}

.alert-box {
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  background: #fef3c7;
  border: 1px solid #fbbf24;
}

.alert-box i {
  color: #f59e0b;
  font-size: 20px;
}

.template-btn {
  background: #f3f4f6;
  border: 1px solid var(--border);
  padding: 10px 14px;
  border-radius: 6px;
  cursor: pointer;
  margin: 4px;
  font-size: 13px;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.template-btn:hover {
  background: #e5e7eb;
  border-color: var(--accent);
}

.bulk-actions-bar {
  display: none;
  align-items: center;
  gap: 10px;
  padding: 12px;
  background: #f9fafb;
  border: 1px solid var(--border);
  border-radius: 6px;
  margin-bottom: 16px;
}

.bulk-actions-bar.show {
  display: flex;
}

.checkbox-review {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.inline-edit-form {
  margin-top: 12px;
}

.inline-edit-form textarea {
  width: 100%;
  min-height: 80px;
  margin-bottom: 8px;
}

.auto-save-indicator {
  font-size: 12px;
  color: var(--muted);
  font-style: italic;
}

.export-menu {
  position: relative;
  display: inline-block;
}

.export-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border: 1px solid var(--border);
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  min-width: 150px;
  z-index: 100;
  margin-top: 4px;
}

.export-dropdown.show {
  display: block;
}

.export-dropdown button {
  width: 100%;
  text-align: left;
  padding: 10px 14px;
  border: none;
  background: none;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s;
}

.export-dropdown button:hover {
  background: #f3f4f6;
}
</style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay" style="display:none;">
  <div class="loading-spinner"></div>
  <p>Loading...</p>
</div>

<button class="back-btn" onclick="history.back()">
  <i class="fas fa-chevron-left"></i> Back
</button>

<div class="wrap">
  <h1>‚≠ê My Reviews</h1>
  
  <!-- Pending Reviews Alert -->
  <div id="pendingAlert" class="alert-box" style="display:none;">
    <i class="fas fa-bell"></i>
    <div style="flex:1">
      <strong>You have <span id="pendingCount">0</span> products waiting for review!</strong>
      <p style="margin:4px 0 0;font-size:13px">Share your experience to help others</p>
    </div>
    <button class="btn" onclick="showPendingProducts()">Review Now</button>
  </div>

  <div class="grid">
    <!-- LEFT: Reviews list -->
    <main>
      <div class="card">
        <!-- Bulk Actions Bar -->
        <div id="bulkActionsBar" class="bulk-actions-bar">
          <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)">
          <span id="selectedCount">0 selected</span>
          <button class="btn btn-danger" onclick="bulkDelete()">
            <i class="fas fa-trash"></i> Delete Selected
          </button>
          <button class="btn ghost" onclick="clearSelection()">Cancel</button>
        </div>

        <div class="controls">
          <select id="sortBy">
            <option value="newest">Sort: Newest</option>
            <option value="oldest">Sort: Oldest</option>
            <option value="highest">Sort: Highest rating</option>
            <option value="lowest">Sort: Lowest rating</option>
          </select>
          <select id="filterStar">
            <option value="">All ratings</option>
            <option value="5">5‚òÖ</option>
            <option value="4">4‚òÖ</option>
            <option value="3">3‚òÖ</option>
            <option value="2">2‚òÖ</option>
            <option value="1">1‚òÖ</option>
          </select>
          <input type="search" id="searchQuery" placeholder="Search reviews..." />
          <button id="clearFilters" class="btn ghost">Clear</button>
          <button class="btn ghost" onclick="toggleBulkMode()">
            <i class="fas fa-check-square"></i> Select
          </button>
          <div class="export-menu">
            <button class="btn ghost" onclick="toggleExportMenu()">
              <i class="fas fa-download"></i> Export
            </button>
            <div id="exportDropdown" class="export-dropdown">
              <button onclick="exportReviews('csv')">
                <i class="fas fa-file-csv"></i> Export as CSV
              </button>
              <button onclick="exportReviews('json')">
                <i class="fas fa-file-code"></i> Export as JSON
              </button>
            </div>
          </div>
        </div>

        <div id="reviewList" class="review-list"></div>
      </div>
    </main>

    <!-- RIGHT: Summary + Analytics + Write new review -->
    <aside>
      <!-- Analytics Dashboard -->
      <div class="card">
        <h4>üìä Review Analytics</h4>
        <div class="analytics-grid">
          <div class="stat-box">
            <div class="stat-number" id="avgRating">0.0</div>
            <div class="stat-label">Avg Rating</div>
          </div>
          <div class="stat-box">
            <div class="stat-number" id="totalReviews">0</div>
            <div class="stat-label">Total Reviews</div>
          </div>
          <div class="stat-box">
            <div class="stat-number" id="totalHelpful">0</div>
            <div class="stat-label">Helpful Votes</div>
          </div>
          <div class="stat-box">
            <div class="stat-number" id="totalViews">0</div>
            <div class="stat-label">Total Views</div>
          </div>
        </div>
        
        <!-- Badges -->
        <div id="badgesContainer" style="margin-top:12px;">
          <h5 style="margin:0 0 8px;font-size:13px;color:var(--muted)">Your Achievements</h5>
          <div id="badgesList"></div>
        </div>
      </div>

      <!-- Write New Review -->
      <div class="card" style="margin-top:12px">
        <h4>‚úçÔ∏è Write New Review</h4>
        
        <!-- Templates -->
        <div style="margin:12px 0">
          <p class="small muted">Quick templates:</p>
          <button class="template-btn" onclick="useTemplate('positive')">
            üòä Positive
          </button>
          <button class="template-btn" onclick="useTemplate('detailed')">
            üìù Detailed
          </button>
          <button class="template-btn" onclick="useTemplate('issue')">
            ‚ö†Ô∏è Had Issues
          </button>
        </div>
        
        <p class="small muted">Select a recently delivered product</p>
        <select id="dropProductSelect" style="width:100%;padding:10px;margin:10px 0"></select>
        <button class="btn" style="width:100%" id="dropReviewBtn">Drop a Review</button>
      </div>
    </aside>
  </div>
</div>

<!-- Write/Edit Review Modal -->
<div id="reviewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Write a Review</h2>
      <button class="close-modal" onclick="closeReviewModal()">&times;</button>
    </div>
    
    <form id="reviewForm" onsubmit="submitReview(event)">
      <div class="form-group required">
        <label>Select Product</label>
        <select id="productSelect" required>
          <option value="">Loading products...</option>
        </select>
      </div>

      <div class="form-group required">
        <label>Rating</label>
        <div class="star-input" id="starRating">
          <button type="button" data-rating="1">‚òÖ</button>
          <button type="button" data-rating="2">‚òÖ</button>
          <button type="button" data-rating="3">‚òÖ</button>
          <button type="button" data-rating="4">‚òÖ</button>
          <button type="button" data-rating="5">‚òÖ</button>
        </div>
        <input type="hidden" id="ratingValue" required>
      </div>

      <div class="form-group required">
        <label>Review</label>
        <textarea id="reviewBody" rows="5" placeholder="Share your experience with this product..." required></textarea>
        <small class="muted">Between 4 and 1200 characters</small>
        <div class="auto-save-indicator" id="autoSaveStatus"></div>
      </div>

      <div class="form-group">
        <label>Add Photos/Videos (Optional)</label>
        <input type="file" id="mediaInput" multiple accept="image/*,video/*">
        <small class="muted">Max 5 files, 10MB each</small>
        <div id="mediaPreview" class="media-preview"></div>
      </div>

      <div style="display:flex;gap:10px;margin-top:20px">
        <button type="submit" class="btn" id="submitBtn">
          <i class="fas fa-paper-plane"></i> Submit Review
        </button>
        <button type="button" class="btn ghost" onclick="closeReviewModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Image Zoom Modal -->
<div id="zoomModal" class="zoom-modal" onclick="closeZoom()">
  <button class="zoom-close">&times;</button>
  <div id="zoomContent"></div>
</div>

<div id="toast" class="toast success">Saved</div>

<footer>¬© MarketMix 2025</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
// ==============================================
// CONFIGURATION
// ==============================================
// Prefer global CONFIG.API_BASE_URL when present
const API_BASE_URL = (window.CONFIG && CONFIG.API_BASE_URL) ? CONFIG.API_BASE_URL : 'https://marketmix-backend.onrender.com/api';
let allReviews = [];
let purchasedProducts = [];
let currentEditingId = null;
let currentRating = 0;
let selectedFiles = [];
let bulkModeActive = false;
let selectedReviewIds = new Set();
let autoSaveTimer = null;

// Review Templates
const reviewTemplates = {
  positive: "I'm really happy with this product! The quality exceeded my expectations and it arrived quickly. Would definitely recommend to others.",
  detailed: "Quality: Great build and materials\nValue: Good price for what you get\nDelivery: Fast and well-packaged\nOverall: Very satisfied with this purchase",
  issue: "While the product has good features, I experienced some issues with [describe issue]. However, customer service was helpful in resolving it."
};

// ==============================================
// UTILITY FUNCTIONS
// ==============================================
function showToast(msg, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = `toast ${type} show`;
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function showLoading(show = true, message = 'Loading...') {
  const overlay = document.getElementById('loadingOverlay');
  overlay.style.display = show ? 'flex' : 'none';
  if (show) {
    overlay.querySelector('p').textContent = message;
  }
}

function formatStars(rating) {
  return '‚òÖ'.repeat(rating) + '‚òÜ'.repeat(5 - rating);
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// ==============================================
// AUTO-SAVE DRAFT FUNCTIONALITY
// ==============================================
function saveDraft() {
  const productId = document.getElementById('productSelect').value;
  const rating = document.getElementById('ratingValue').value;
  const body = document.getElementById('reviewBody').value;
  
  if (productId && (rating || body)) {
    const draft = {
      productId,
      rating,
      body,
      timestamp: Date.now()
    };
    
    localStorage.setItem(`review_draft_${productId}`, JSON.stringify(draft));
    
    const indicator = document.getElementById('autoSaveStatus');
    indicator.textContent = '‚úì Draft saved';
    indicator.style.color = 'var(--success)';
    
    setTimeout(() => {
      indicator.textContent = '';
    }, 2000);
  }
}

function loadDraft(productId) {
  const draftKey = `review_draft_${productId}`;
  const draft = localStorage.getItem(draftKey);
  
  if (draft) {
    try {
      const parsed = JSON.parse(draft);
      
      // Check if draft is less than 7 days old
      const age = Date.now() - parsed.timestamp;
      if (age < 7 * 24 * 60 * 60 * 1000) {
        if (confirm('Found a saved draft for this product. Would you like to restore it?')) {
          document.getElementById('ratingValue').value = parsed.rating;
          document.getElementById('reviewBody').value = parsed.body;
          
          // Update star rating display
          currentRating = parseInt(parsed.rating);
          const stars = document.querySelectorAll('#starRating button');
          stars.forEach((s, i) => {
            s.classList.toggle('active', i < currentRating);
          });
          
          showToast('Draft restored', 'info');
        }
      } else {
        // Clean up old draft
        localStorage.removeItem(draftKey);
      }
    } catch (e) {
      console.error('Error loading draft:', e);
    }
  }
}

function clearDraft(productId) {
  localStorage.removeItem(`review_draft_${productId}`);
}

// Setup auto-save
const debouncedSaveDraft = debounce(saveDraft, 2000);

// ==============================================
// REVIEW TEMPLATES
// ==============================================
function useTemplate(type) {
  const template = reviewTemplates[type];
  if (!template) return;
  
  const textarea = document.getElementById('reviewBody');
  
  if (textarea.value && !confirm('This will replace your current text. Continue?')) {
    return;
  }
  
  textarea.value = template;
  showToast('Template applied! Feel free to customize it.', 'info');
}

// ==============================================
// BULK ACTIONS
// ==============================================
function toggleBulkMode() {
  bulkModeActive = !bulkModeActive;
  const checkboxes = document.querySelectorAll('.checkbox-review');
  const bulkBar = document.getElementById('bulkActionsBar');
  
  if (bulkModeActive) {
    checkboxes.forEach(cb => cb.style.display = 'block');
    bulkBar.classList.add('show');
  } else {
    checkboxes.forEach(cb => {
      cb.style.display = 'none';
      cb.checked = false;
    });
    bulkBar.classList.remove('show');
    selectedReviewIds.clear();
    updateSelectedCount();
  }
}

function toggleSelectAll(checked) {
  const checkboxes = document.querySelectorAll('.checkbox-review');
  checkboxes.forEach(cb => {
    cb.checked = checked;
    const reviewId = cb.dataset.reviewId;
    if (checked) {
      selectedReviewIds.add(reviewId);
    } else {
      selectedReviewIds.delete(reviewId);
    }
  });
  updateSelectedCount();
}

function toggleReviewSelection(reviewId, checked) {
  if (checked) {
    selectedReviewIds.add(reviewId);
  } else {
    selectedReviewIds.delete(reviewId);
    document.getElementById('selectAll').checked = false;
  }
  updateSelectedCount();
}

function updateSelectedCount() {
  document.getElementById('selectedCount').textContent = `${selectedReviewIds.size} selected`;
}

function clearSelection() {
  toggleBulkMode();
}

async function bulkDelete() {
  if (selectedReviewIds.size === 0) {
    showToast('No reviews selected', 'error');
    return;
  }

  if (!confirm(`Delete ${selectedReviewIds.size} review(s)? This cannot be undone.`)) {
    return;
  }

  showLoading(true, 'Deleting reviews...');

  try {
    const token = localStorage.getItem('token');
    const deletePromises = Array.from(selectedReviewIds).map(reviewId =>
      fetch(`${API_BASE_URL}/reviews/${reviewId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      }).then(async res => {
        const json = await res.json().catch(() => ({}));
        return { ok: res.ok, status: res.status, body: json, reviewId };
      }).catch(err => ({ ok: false, error: err, reviewId }))
    );

    const results = await Promise.allSettled(deletePromises);

    let successful = 0;
    const failed = [];

    results.forEach(r => {
      if (r.status === 'fulfilled' && r.value && r.value.ok && r.value.body && r.value.body.status === 'success') {
        successful += 1;
      } else if (r.status === 'fulfilled') {
        failed.push(r.value);
      } else {
        failed.push(r.reason);
      }
    });

    if (successful > 0) {
      showToast(`${successful} review(s) deleted successfully`, 'success');
    }
    if (failed.length > 0) {
      console.error('Bulk delete failures:', failed);
      showToast(`${failed.length} deletion(s) failed`, 'error');
    }

    // Clear selection and refresh data
    selectedReviewIds.clear();
    if (bulkModeActive) toggleBulkMode();
    await loadMyReviews();
    await loadPurchasedProducts();
  } catch (error) {
    console.error('Error bulk deleting:', error);
    showToast('Failed to delete some reviews', 'error');
  } finally {
    showLoading(false);
  }
}

// ==============================================
// EVENT LISTENERS & INITIALIZATION
// ==============================================
document.addEventListener('DOMContentLoaded', () => {
  loadMyReviews();
  loadPurchasedProducts();
  initializeStarRating();

  document.getElementById('sortBy').addEventListener('change', renderReviews);
  document.getElementById('filterStar').addEventListener('change', renderReviews);
  
  const debouncedSearch = debounce(renderReviews, 300);
  document.getElementById('searchQuery').addEventListener('input', debouncedSearch);

  document.getElementById('clearFilters').addEventListener('click', () => {
    document.getElementById('sortBy').value = 'newest';
    document.getElementById('filterStar').value = '';
    document.getElementById('searchQuery').value = '';
    renderReviews();
  });

  document.getElementById('mediaInput').addEventListener('change', handleFileSelect);

  document.getElementById('reviewModal').addEventListener('click', (e) => {
    if (e.target.id === 'reviewModal') {
      closeReviewModal();
    }
  });
});

// ==============================================
// EXPORT FUNCTIONALITY
// ==============================================
function toggleExportMenu() {
  const dropdown = document.getElementById('exportDropdown');
  dropdown.classList.toggle('show');
}

// Close export menu when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.export-menu')) {
    document.getElementById('exportDropdown').classList.remove('show');
  }
});

function exportReviews(format) {
  if (allReviews.length === 0) {
    showToast('No reviews to export', 'error');
    return;
  }
  
  const exportData = allReviews.map(r => ({
    product: r.productName || 'Unknown',
    rating: r.rating,
    review: r.body,
    date: new Date(r.createdAt).toLocaleDateString(),
    helpful_votes: r.helpfulCount || 0,
    verified: r.verifiedPurchase ? 'Yes' : 'No'
  }));
  
  if (format === 'csv') {
    const csv = Papa.unparse(exportData);
    downloadFile(csv, 'my-reviews.csv', 'text/csv');
    showToast('Reviews exported as CSV', 'success');
  } else if (format === 'json') {
    const json = JSON.stringify(exportData, null, 2);
    downloadFile(json, 'my-reviews.json', 'application/json');
    showToast('Reviews exported as JSON', 'success');
  }
  
  document.getElementById('exportDropdown').classList.remove('show');
}

function downloadFile(content, filename, type) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ==============================================
// ANALYTICS & BADGES
// ==============================================
function updateAnalytics() {
  const total = allReviews.length;
  const avg = total > 0 ? (allReviews.reduce((sum, r) => sum + r.rating, 0) / total).toFixed(1) : 0;
  const totalHelpful = allReviews.reduce((sum, r) => sum + (r.helpfulCount || 0), 0);
  const totalViews = allReviews.reduce((sum, r) => sum + (r.viewCount || 0), 0);
  
  document.getElementById('avgRating').textContent = avg;
  document.getElementById('totalReviews').textContent = total;
  document.getElementById('totalHelpful').textContent = totalHelpful;
  document.getElementById('totalViews').textContent = totalViews;
  
  // Update badges
  updateBadges(total, totalHelpful, allReviews);
}

function updateBadges(reviewCount, helpfulCount, reviews) {
  const badges = [];
  
  if (reviewCount >= 50) {
    badges.push({ icon: 'üèÜ', text: 'Top Reviewer', color: '#fbbf24' });
  } else if (reviewCount >= 25) {
    badges.push({ icon: '‚≠ê', text: 'Power Reviewer', color: '#f97316' });
  } else if (reviewCount >= 10) {
    badges.push({ icon: '‚úçÔ∏è', text: '10+ Reviews', color: '#3b82f6' });
  } else if (reviewCount >= 5) {
    badges.push({ icon: 'üìù', text: '5+ Reviews', color: '#8b5cf6' });
  }
  
  if (helpfulCount >= 50) {
    badges.push({ icon: 'üí¨', text: 'Helpful Reviewer', color: '#10b981' });
  }
  
  const mediaReviews = reviews.filter(r => r.media && r.media.length > 0).length;
  if (mediaReviews >= 5) {
    badges.push({ icon: 'üì∏', text: 'Media Master', color: '#ec4899' });
  }
  
  const highRatingReviews = reviews.filter(r => r.rating >= 4).length;
  if (highRatingReviews >= 10) {
    badges.push({ icon: 'üòä', text: 'Positive Vibes', color: '#14b8a6' });
  }
  
  const badgesList = document.getElementById('badgesList');
  if (badges.length === 0) {
    badgesList.innerHTML = '<p class="small muted">Write more reviews to earn badges!</p>';
  } else {
    badgesList.innerHTML = badges.map(b => 
      `<span class="badge-achievement" style="background:${b.color}20;color:${b.color}">${b.icon} ${b.text}</span>`
    ).join('');
  }
}

// ==============================================
// PENDING REVIEWS ALERT
// ==============================================
function updatePendingAlert() {
  const pendingProducts = purchasedProducts.filter(p => !p.alreadyReviewed);
  
  if (pendingProducts.length > 0) {
    document.getElementById('pendingCount').textContent = pendingProducts.length;
    document.getElementById('pendingAlert').style.display = 'flex';
  } else {
    document.getElementById('pendingAlert').style.display = 'none';
  }
}

function showPendingProducts() {
  // Open modal and pre-select first pending product
  const pendingProducts = purchasedProducts.filter(p => !p.alreadyReviewed);
  if (pendingProducts.length > 0) {
    showWriteReviewForm();
    document.getElementById('productSelect').value = pendingProducts[0].id;
  }
}

// ==============================================
// INLINE EDIT MODE
// ==============================================
function enableInlineEdit(reviewId) {
  const review = allReviews.find(r => r.id === reviewId);
  if (!review) return;
  
  const reviewEl = document.querySelector(`[data-review-id="${reviewId}"]`);
  if (!reviewEl) return;
  
  reviewEl.classList.add('editing');
  
  const contentDiv = reviewEl.querySelector('.review-content');
  const originalText = review.body;
  
  contentDiv.innerHTML = `
    <div class="inline-edit-form">
      <div class="star-input" id="inline-star-${reviewId}">
        ${[1,2,3,4,5].map(i => `<button type="button" data-rating="${i}" class="${i <= review.rating ? 'active' : ''}" onclick="updateInlineStars('${reviewId}', ${i})">‚òÖ</button>`).join('')}
      </div>
      <textarea id="inline-text-${reviewId}" style="width:100%;min-height:80px;margin:8px 0">${escapeHtml(originalText)}</textarea>
      <div style="display:flex;gap:8px">
        <button class="btn btn-success" onclick="saveInlineEdit('${reviewId}')">
          <i class="fas fa-save"></i> Save
        </button>
        <button class="btn ghost" onclick="cancelInlineEdit('${reviewId}', \`${escapeHtml(originalText)}\`)">
          Cancel
        </button>
      </div>
    </div>
  `;
}

function updateInlineStars(reviewId, rating) {
  const stars = document.querySelectorAll(`#inline-star-${reviewId} button`);
  stars.forEach((s, i) => {
    s.classList.toggle('active', i < rating);
  });
}

async function saveInlineEdit(reviewId) {
  const textarea = document.getElementById(`inline-text-${reviewId}`);
  const stars = document.querySelectorAll(`#inline-star-${reviewId} button.active`);
  const newRating = stars.length;
  const newText = textarea.value.trim();
  
  if (!newText || newText.length < 4 || newText.length > 1200) {
    showToast('Review must be 4-1200 characters', 'error');
    return;
  }
  
  if (!newRating) {
    showToast('Please select a rating', 'error');
    return;
  }
  
  showLoading(true, 'Saving...');
  
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_BASE_URL}/reviews/${reviewId}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        rating: newRating,
        body: newText
      })
    });
    
    const data = await response.json();
    
    if (response.ok && data.status === 'success') {
      showToast('Review updated successfully!', 'success');
      await loadMyReviews();
    } else {
      throw new Error(data.message || 'Failed to update review');
    }
  } catch (error) {
    console.error('Error updating review:', error);
    showToast(error.message || 'Failed to update review', 'error');
  } finally {
    showLoading(false);
  }
}

function cancelInlineEdit(reviewId, originalText) {
  renderReviews();
}

// ==============================================
// LOAD REVIEWS
// ==============================================
async function loadMyReviews() {
  showLoading(true, 'Loading reviews...');
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_BASE_URL}/reviews/my-reviews`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    const data = await response.json();

    if (response.ok && data.status === 'success') {
      allReviews = data.data.reviews;
      renderReviews();
      updateAnalytics();
    } else {
      throw new Error(data.message || 'Failed to load reviews');
    }
  } catch (error) {
    console.error('Error loading reviews:', error);
    showToast(error.message || 'Failed to load reviews', 'error');
  } finally {
    showLoading(false);
  }
}

// ==============================================
// LOAD PURCHASED PRODUCTS
// ==============================================
async function loadPurchasedProducts() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_BASE_URL}/orders/purchased-products`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    const data = await response.json();

    if (response.ok && data.status === 'success') {
      purchasedProducts = data.data.products;
      populateProductSelect();
      populateDropProductSelect();
      setupDropReviewButton();
      updatePendingAlert();
      if (typeof processQueryParamsForReview === 'function') processQueryParamsForReview();
    } else {
      throw new Error(data.message || 'Failed to load products');
    }
  } catch (error) {
    console.error('Error loading products:', error);
    document.getElementById('productSelect').innerHTML = '<option value="">No products available</option>';
  }
}

function populateProductSelect() {
  const select = document.getElementById('productSelect');
  
  if (purchasedProducts.length === 0) {
    select.innerHTML = '<option value="">No purchased products available</option>';
    return;
  }

  select.innerHTML = '<option value="">Select a product...</option>';
  purchasedProducts.forEach(product => {
    const option = document.createElement('option');
    option.value = product.id;
    option.textContent = product.name;
    option.dataset.orderId = product.orderId;
    
    if (product.alreadyReviewed) {
      option.textContent += ' (Already reviewed)';
      option.disabled = true;
    }
    
    select.appendChild(option);
  });
}

function populateDropProductSelect() {
  const select = document.getElementById('dropProductSelect');
  if (!select) return;

  const candidates = purchasedProducts.filter(p => !p.alreadyReviewed).slice(0,5);

  if (candidates.length === 0) {
    select.innerHTML = '<option value="">No eligible delivered products</option>';
    return;
  }

  select.innerHTML = '<option value="">Select a product to review...</option>';
  candidates.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name;
    opt.dataset.orderId = p.orderId;
    select.appendChild(opt);
  });
}

function setupDropReviewButton() {
  const btn = document.getElementById('dropReviewBtn');
  if (!btn) return;

  btn.addEventListener('click', () => {
    const select = document.getElementById('dropProductSelect');
    if (!select) return;
    const productId = select.value;
    if (!productId) {
      alert('Please choose a product to review');
      return;
    }

    const product = purchasedProducts.find(p => String(p.id) === String(productId));
    if (!product) {
      alert('Selected product not found');
      return;
    }

    showWriteReviewForm();
    document.getElementById('productSelect').value = product.id;
    
    // Load draft if exists
    setTimeout(() => loadDraft(product.id), 100);
  });
}

// If the page was opened with ?product=...&order=... (e.g., from Purchase History), pre-select and open the review flow
function processQueryParamsForReview() {
  try {
    const params = new URLSearchParams(window.location.search);
    const productParam = params.get('product');
    const orderParam = params.get('order');
    if (!productParam && !orderParam) return;

    // If an order is specified, open the review modal for that product/order immediately
    if (productParam && orderParam) {
      const productSelect = document.getElementById('productSelect');
      const option = productSelect ? productSelect.querySelector(`option[value="${productParam}"]`) : null;
      if (option) {
        option.dataset.orderId = orderParam;
        productSelect.value = productParam;
      }

      showWriteReviewForm();
      setTimeout(() => loadDraft(productParam), 120);
      return;
    }

    // If only product is supplied, try to pre-select it in the Drop Review selector if present
    if (productParam) {
      const dropSelect = document.getElementById('dropProductSelect');
      const dropOption = dropSelect ? Array.from(dropSelect.options).find(o => o.value === productParam) : null;
      if (dropOption) {
        dropSelect.value = productParam;
        dropSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
        showToast('Product selected ‚Äî click "Drop a Review" to leave your review', 'info');
        return;
      }

      const productSelect = document.getElementById('productSelect');
      const option = productSelect ? productSelect.querySelector(`option[value="${productParam}"]`) : null;
      if (option) {
        productSelect.value = productParam;
        showToast('This product is pre-selected. To submit a review, open Purchase History and click "Drop Review" for the delivered order.', 'info');
      }
    }
  } catch (e) {
    console.error('Error processing review query params:', e);
  }
}

// ==============================================
// RENDER REVIEWS
// ==============================================
function renderReviews() {
  const container = document.getElementById('reviewList');
  const sortBy = document.getElementById('sortBy').value;
  const filterStar = document.getElementById('filterStar').value;
  const query = document.getElementById('searchQuery').value.toLowerCase();

  let filtered = allReviews.slice();

  if (filterStar) {
    filtered = filtered.filter(r => r.rating == filterStar);
  }

  if (query) {
    filtered = filtered.filter(r => 
      (r.body || '').toLowerCase().includes(query) ||
      (r.productName || '').toLowerCase().includes(query)
    );
  }

  if (sortBy === 'newest') {
    filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  } else if (sortBy === 'oldest') {
    filtered.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
  } else if (sortBy === 'highest') {
    filtered.sort((a, b) => b.rating - a.rating);
  } else if (sortBy === 'lowest') {
    filtered.sort((a, b) => a.rating - b.rating);
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="fas fa-star" style="font-size:48px;color:#ddd;"></i><p>No reviews yet. Share your experience with products you\'ve purchased! üåü</p></div>';
    return;
  }

  container.innerHTML = '';

  filtered.forEach(review => {
    const div = document.createElement('div');
    div.className = 'review';
    div.dataset.reviewId = review.id;
    
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    const initial = (user.firstName || 'U')[0].toUpperCase();

    let mediaHtml = '';
    if (review.media && review.media.length > 0) {
      mediaHtml = '<div class="review-media">';
      review.media.forEach((m, idx) => {
        if (m.type === 'image') {
          mediaHtml += `<img src="${m.url}" alt="Review photo" onclick="openZoom('${m.url}', 'image')">`;
        } else {
          mediaHtml += `<video controls src="${m.url}"></video>`;
        }
      });
      mediaHtml += '</div>';
    }

    let repliesHtml = '';
    if (review.replies && review.replies.length > 0) {
      review.replies.forEach(reply => {
        repliesHtml += `<div class="seller-reply"><strong>Seller:</strong> ${escapeHtml(reply.text)}</div>`;
      });
    }

    let statusBadge = '';
    if (review.status === 'flagged') {
      statusBadge = '<span class="badge badge-warning"><i class="fas fa-flag"></i> Flagged</span>';
    }

    const checkboxDisplay = bulkModeActive ? 'block' : 'none';

    div.innerHTML = `
      <input type="checkbox" class="checkbox-review" data-review-id="${review.id}" 
             style="display:${checkboxDisplay}" onchange="toggleReviewSelection('${review.id}', this.checked)">
      <div class="avatar">${initial}</div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:start">
          <div>
            <strong>${escapeHtml(review.productName || 'Product')}</strong>
            ${review.verifiedPurchase ? '<span class="verified-badge"><i class="fas fa-check"></i> Verified</span>' : ''}
            ${statusBadge}
            <div class="stars">${formatStars(review.rating)}</div>
            <div class="meta">${new Date(review.createdAt).toLocaleDateString()}</div>
          </div>
          <div>
            <span class="small muted"><i class="fas fa-thumbs-up"></i> ${review.helpfulCount || 0}</span>
          </div>
        </div>
        <div class="review-content" style="margin-top:8px">${escapeHtml(review.body)}</div>
        ${mediaHtml}
        ${repliesHtml}
        <div style="margin-top:10px">
          <button class="btn ghost" onclick="enableInlineEdit('${review.id}')"><i class="fas fa-edit"></i> Quick Edit</button>
          <button class="btn ghost" onclick="editReview('${review.id}')"><i class="fas fa-pen"></i> Full Edit</button>
          <button class="btn ghost" onclick="deleteReview('${review.id}')"><i class="fas fa-trash"></i> Delete</button>
        </div>
      </div>
    `;

    container.appendChild(div);
  });
}

// ==============================================
// STAR RATING INTERACTION
// ==============================================
function initializeStarRating() {
  const stars = document.querySelectorAll('#starRating button');
  const ratingInput = document.getElementById('ratingValue');

  stars.forEach((star, index) => {
    star.addEventListener('click', () => {
      currentRating = parseInt(star.dataset.rating);
      ratingInput.value = currentRating;
      
      stars.forEach((s, i) => {
        s.classList.toggle('active', i < currentRating);
      });
    });

    star.addEventListener('mouseenter', () => {
      const hoverRating = parseInt(star.dataset.rating);
      stars.forEach((s, i) => {
        s.classList.toggle('active', i < hoverRating);
      });
    });
  });

  document.getElementById('starRating').addEventListener('mouseleave', () => {
    stars.forEach((s, i) => {
      s.classList.toggle('active', i < currentRating);
    });
  });
}

// ==============================================
// FILE HANDLING
// ==============================================
function handleFileSelect(event) {
  const files = Array.from(event.target.files);
  
  if (selectedFiles.length + files.length > 5) {
    showToast('Maximum 5 files allowed', 'error');
    return;
  }

  for (const file of files) {
    if (file.size > 10 * 1024 * 1024) {
      showToast(`${file.name} exceeds 10MB limit`, 'error');
      continue;
    }

    if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
      showToast(`${file.name} is not a valid image or video`, 'error');
      continue;
    }

    selectedFiles.push(file);
  }

  updateMediaPreview();
  event.target.value = '';
}

function updateMediaPreview() {
  const preview = document.getElementById('mediaPreview');
  preview.innerHTML = '';

  selectedFiles.forEach((file, index) => {
    const div = document.createElement('div');
    div.className = 'media-preview-item';

    const reader = new FileReader();
    reader.onload = (e) => {
      if (file.type.startsWith('image/')) {
        div.innerHTML = `
          <img src="${e.target.result}" alt="Preview">
          <button type="button" onclick="removeFile(${index})">&times;</button>
        `;
      } else {
        div.innerHTML = `
          <video src="${e.target.result}"></video>
          <button type="button" onclick="removeFile(${index})">&times;</button>
        `;
      }
    };
    reader.readAsDataURL(file);

    preview.appendChild(div);
  });
}

function removeFile(index) {
  selectedFiles.splice(index, 1);
  updateMediaPreview();
}

// ==============================================
// MODAL FUNCTIONS
// ==============================================
function showWriteReviewForm() {
  currentEditingId = null;
  currentRating = 0;
  selectedFiles = [];
  
  document.getElementById('modalTitle').textContent = 'Write a Review';
  document.getElementById('reviewForm').reset();
  document.getElementById('ratingValue').value = '';
  document.getElementById('mediaPreview').innerHTML = '';
  document.getElementById('autoSaveStatus').textContent = '';
  
  document.querySelectorAll('#starRating button').forEach(s => s.classList.remove('active'));
  
  if (purchasedProducts.length === 0) {
    loadPurchasedProducts();
  }
  
  document.getElementById('reviewModal').classList.add('show');
  
  // Setup auto-save for new review
  const textarea = document.getElementById('reviewBody');
  textarea.removeEventListener('input', debouncedSaveDraft);
  textarea.addEventListener('input', debouncedSaveDraft);
  
  const productSelect = document.getElementById('productSelect');
  productSelect.removeEventListener('change', handleProductChange);
  productSelect.addEventListener('change', handleProductChange);
}

function handleProductChange() {
  const productId = document.getElementById('productSelect').value;
  if (productId) {
    loadDraft(productId);
  }
}

function closeReviewModal() {
  document.getElementById('reviewModal').classList.remove('show');
  currentEditingId = null;
  currentRating = 0;
  selectedFiles = [];
}

function openZoom(url, type) {
  const modal = document.getElementById('zoomModal');
  const content = document.getElementById('zoomContent');
  
  if (type === 'image') {
    // NOTE: Validate/sanitize 'url' before injecting into innerHTML to avoid XSS
    content.innerHTML = `<img src="${url}" alt="Zoomed image">`;
  } else {
    // NOTE: Validate/sanitize 'url' before injecting into innerHTML to avoid XSS
    content.innerHTML = `<video controls src="${url}"></video>`;
  }
  
  modal.classList.add('show');
}

function closeZoom() {
  document.getElementById('zoomModal').classList.remove('show');
  document.getElementById('zoomContent').innerHTML = '';
}

// ==============================================
// EDIT REVIEW
// ==============================================
async function editReview(reviewId) {
  const review = allReviews.find(r => r.id === reviewId);
  if (!review) {
    showToast('Review not found', 'error');
    return;
  }

  currentEditingId = reviewId;
  currentRating = review.rating;
  selectedFiles = [];

  document.getElementById('modalTitle').textContent = 'Edit Review';
  document.getElementById('productSelect').value = review.productId;
  document.getElementById('reviewBody').value = review.body;
  document.getElementById('ratingValue').value = review.rating;

  const stars = document.querySelectorAll('#starRating button');
  stars.forEach((s, i) => {
    s.classList.toggle('active', i < currentRating);
  });

  document.getElementById('reviewModal').classList.add('show');
}

// ==============================================
// SUBMIT REVIEW
// ==============================================
async function submitReview(event) {
  event.preventDefault();

  const productId = document.getElementById('productSelect').value;
  const rating = parseInt(document.getElementById('ratingValue').value);
  const body = document.getElementById('reviewBody').value.trim();

  if (!productId) {
    showToast('Please select a product', 'error');
    return;
  }

  if (!rating || rating < 1 || rating > 5) {
    showToast('Please select a rating', 'error');
    return;
  }

  if (body.length < 4) {
    showToast('Review must be at least 4 characters', 'error');
    return;
  }

  if (body.length > 1200) {
    showToast('Review must be less than 1200 characters', 'error');
    return;
  }

  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

  try {
    const token = localStorage.getItem('token');
    
    const mediaArray = [];
    for (const file of selectedFiles.slice(0, 3)) {
      const base64 = await fileToBase64(file);
      mediaArray.push({
        type: file.type,
        data: base64
      });
    }

    const selectedOption = document.querySelector(`#productSelect option[value="${productId}"]`);
    const orderId = selectedOption ? selectedOption.dataset.orderId : null;

    const payload = {
      review_type: 'product',
      product_id: productId,
      rating: rating,
      body: body,
      order_id: orderId,
      media: mediaArray.length > 0 ? mediaArray : undefined
    };

    let url = `${API_BASE_URL}/reviews`;
    let method = 'POST';

    if (currentEditingId) {
      url = `${API_BASE_URL}/reviews/${currentEditingId}`;
      method = 'PUT';
      delete payload.review_type;
      delete payload.product_id;
      delete payload.order_id;
      delete payload.media;
    }

    const response = await fetch(url, {
      method: method,
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    const data = await response.json();

    if (response.ok && data.status === 'success') {
      showToast(currentEditingId ? 'Review updated successfully!' : 'Review submitted successfully!', 'success');
      
      // Clear draft after successful submission
      if (!currentEditingId) {
        clearDraft(productId);
      }
      
      closeReviewModal();
      await loadMyReviews();
      await loadPurchasedProducts(); // Refresh to update "already reviewed" status
    } else {
      throw new Error(data.message || 'Failed to submit review');
    }
  } catch (error) {
    console.error('Error submitting review:', error);
    showToast(error.message || 'Failed to submit review', 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Review';
  }
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// ==============================================
// DELETE REVIEW
// ==============================================
async function deleteReview(reviewId) {
  if (!confirm('Are you sure you want to delete this review? This action cannot be undone.')) {
    return;
  }

  showLoading(true, 'Deleting review...');

  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_BASE_URL}/reviews/${reviewId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    const data = await response.json().catch(() => ({}));

    if (response.ok && data.status === 'success') {
      showToast('Review deleted successfully', 'success');
      await loadMyReviews();
      await loadPurchasedProducts();
    } else {
      throw new Error(data.message || 'Failed to delete review');
    }
  } catch (error) {
    console.error('Error deleting review:', error);
    showToast(error.message || 'Failed to delete review', 'error');
  } finally {
    showLoading(false);
  }
}

</script>
</body>
</html>