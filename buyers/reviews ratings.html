<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- üîí BLOCK UNAUTHORIZED USERS -->
<script>
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.replace("login for buyers.html");
  }
</script>
<title>My Reviews ‚Äî MarketMix</title>

<style>
:root {
  --bg: #FFF7ED;
  --card: #ffffff;
  --border: #e0e0e0;
  --muted: #666;
  --accent: #F97316;
  --gold: #d1c323;
  --success: #38a169;
  --danger: #e53e3e;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
  background: #FFF7ED;
  color: #222;
  line-height: 1.6;
}

.wrap {
  max-width: 1200px;
  margin: 32px auto;
  padding: 20px;
}

h1 { text-align: center; margin-bottom: 24px; }

.grid {
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 20px;
}
@media (max-width: 920px) {
  .grid { grid-template-columns: 1fr; }
}

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 18px;
  box-shadow: 0 6px 12px rgba(0,0,0,0.08);
}

.controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

.controls select,
.controls input[type=search] {
  padding: 10px 12px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: #f5f5f5;
  font-size: 15px;
}

.controls input[type=search] {
  flex: 2;
  min-width: 240px;
}

.review-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.review {
  display: flex;
  gap: 14px;
  padding: 14px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: #fff;
}

.avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: #fff;
  flex-shrink: 0;
}

.stars { color: var(--gold); font-size: 18px; }

.meta {
  font-size: 13px;
  color: var(--muted);
  margin-top: 4px;
}

.btn {
  background: var(--accent);
  color: #fff;
  padding: 8px 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  margin-right: 8px;
}

.btn:hover { background: #EA580C; }
.btn.ghost {
  background: #f2f2f2;
  color: #333;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

textarea {
  width: 100%;
  min-height: 100px;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid var(--border);
  resize: vertical;
  font-size: 15px;
}

.toast {
  position: fixed;
  right: 20px;
  top: 20px;
  padding: 12px 20px;
  border-radius: 8px;
  color: #fff;
  z-index: 999;
  transform: translateX(120%);
  transition: transform .3s ease;
  font-size: 14px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.show { transform: translateX(0); }

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.95);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid #f0f0f0;
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.back-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #F97316;
  color: #000;
  border: none;
  padding: 10px 16px;
  border-radius: 10px;
  font-size: 16px;
  cursor: pointer;
  margin-bottom: 20px;
  transition: 0.3s;
}

.back-btn:hover {
  background: #EA580C;
  transform: translateY(-2px);
}

.star-input {
  display: flex;
  gap: 5px;
  margin: 10px 0;
}

.star-input button {
  background: none;
  border: none;
  font-size: 32px;
  color: #ddd;
  cursor: pointer;
  padding: 0;
  transition: color 0.2s;
}

.star-input button:hover,
.star-input button.active {
  color: var(--gold);
}

.media-preview {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 10px;
}

.media-preview img,
.media-preview video {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 6px;
  border: 1px solid var(--border);
}

.review-media {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.review-media img,
.review-media video {
  max-width: 150px;
  max-height: 150px;
  object-fit: cover;
  border-radius: 6px;
  border: 1px solid var(--border);
  cursor: pointer;
}

.seller-reply {
  margin-top: 12px;
  padding: 10px;
  background: #f9f9f9;
  border-left: 3px solid var(--accent);
  border-radius: 4px;
  font-size: 14px;
}

footer {
  background: rgba(0, 0, 0, 0.7);
  color: #f8fafc;
  text-align: center;
  padding: 25px 15px;
  margin-top: 60px;
  font-size: 15px;
}

.empty-state {
  text-align: center;
  padding: 40px;
  color: var(--muted);
}

.verified-badge {
  display: inline-block;
  background: var(--success);
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 11px;
  margin-left: 8px;
}
</style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display:none;">
  <div class="loading-spinner"></div>
  <p>Loading reviews...</p>
</div>

<button class="back-btn" onclick="history.back()">
  <i class="fas fa-chevron-left"></i> Back
</button>

<div class="wrap">
  <h1>‚≠ê My Reviews</h1>
  <div class="grid">
    <!-- LEFT: Reviews list -->
    <main>
      <div class="card">
        <div class="controls">
          <select id="sortBy">
            <option value="newest">Sort: Newest</option>
            <option value="oldest">Sort: Oldest</option>
            <option value="highest">Sort: Highest rating</option>
            <option value="lowest">Sort: Lowest rating</option>
          </select>
          <select id="filterStar">
            <option value="">All ratings</option>
            <option value="5">5‚òÖ</option>
            <option value="4">4‚òÖ</option>
            <option value="3">3‚òÖ</option>
            <option value="2">2‚òÖ</option>
            <option value="1">1‚òÖ</option>
          </select>
          <input type="search" id="searchQuery" placeholder="Search reviews..." />
          <button id="clearFilters" class="btn ghost">Clear</button>
        </div>

        <div id="reviewList" class="review-list"></div>
      </div>
    </main>

    <!-- RIGHT: Summary + Write new review -->
    <aside>
      <div class="card">
        <h4>Summary</h4>
        <div style="margin-top:12px">
          <div style="font-size:28px;font-weight:700" id="avgRating">0.0</div>
          <div class="small muted" id="totalReviews">0 reviews</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>Write New Review</h4>
        <p class="small muted">After completing a purchase</p>
        <button class="btn" style="width:100%;margin:10px 0" onclick="showWriteReviewForm()">
          <i class="fas fa-plus"></i> Write Review
        </button>
      </div>
    </aside>
  </div>
</div>

<div id="toast" class="toast success">Saved</div>

<footer>¬© MarketMix 2025</footer>

<script>
// ==============================================
// CONFIGURATION
// ==============================================
const API_BASE_URL = 'https://marketmix-backend-production.up.railway.app/api';
let allReviews = [];
let currentEditingId = null;

// ==============================================
// UTILITY FUNCTIONS
// ==============================================
function showToast(msg, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = `toast ${type} show`;
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function showLoading(show = true) {
  document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

function formatStars(rating) {
  return '‚òÖ'.repeat(rating) + '‚òÜ'.repeat(5 - rating);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ==============================================
// LOAD REVIEWS
// ==============================================
async function loadMyReviews() {
  showLoading(true);
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_BASE_URL}/reviews/my-reviews`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    const data = await response.json();

    if (response.ok && data.status === 'success') {
      allReviews = data.data.reviews;
      renderReviews();
      updateSummary();
    } else {
      throw new Error(data.message || 'Failed to load reviews');
    }
  } catch (error) {
    console.error('Error loading reviews:', error);
    showToast(error.message || 'Failed to load reviews', 'error');
  } finally {
    showLoading(false);
  }
}

// ==============================================
// RENDER REVIEWS
// ==============================================
function renderReviews() {
  const container = document.getElementById('reviewList');
  const sortBy = document.getElementById('sortBy').value;
  const filterStar = document.getElementById('filterStar').value;
  const query = document.getElementById('searchQuery').value.toLowerCase();

  let filtered = allReviews.slice();

  // Filter by rating
  if (filterStar) {
    filtered = filtered.filter(r => r.rating == filterStar);
  }

  // Filter by search query
  if (query) {
    filtered = filtered.filter(r => 
      (r.body || '').toLowerCase().includes(query) ||
      (r.productName || '').toLowerCase().includes(query)
    );
  }

  // Sort
  if (sortBy === 'newest') {
    filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  } else if (sortBy === 'oldest') {
    filtered.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
  } else if (sortBy === 'highest') {
    filtered.sort((a, b) => b.rating - a.rating);
  } else if (sortBy === 'lowest') {
    filtered.sort((a, b) => a.rating - b.rating);
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="fas fa-star" style="font-size:48px;color:#ddd;"></i><p>No reviews yet. Write your first review after purchasing!</p></div>';
    return;
  }

  container.innerHTML = '';

  filtered.forEach(review => {
    const div = document.createElement('div');
    div.className = 'review';
    
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    const initial = (user.firstName || 'U')[0].toUpperCase();

    // Build media HTML
    let mediaHtml = '';
    if (review.media && review.media.length > 0) {
      mediaHtml = '<div class="review-media">';
      review.media.forEach(m => {
        if (m.type === 'image') {
          mediaHtml += `<img src="${m.url}" alt="Review photo" onclick="window.open('${m.url}', '_blank')">`;
        } else {
          mediaHtml += `<video controls src="${m.url}"></video>`;
        }
      });
      mediaHtml += '</div>';
    }

    // Build replies HTML
    let repliesHtml = '';
    if (review.replies && review.replies.length > 0) {
      review.replies.forEach(reply => {
        repliesHtml += `<div class="seller-reply"><strong>Seller:</strong> ${escapeHtml(reply.text)}</div>`;
      });
    }

    div.innerHTML = `
      <div class="avatar">${initial}</div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:start">
          <div>
            <strong>${escapeHtml(review.productName || 'Product')}</strong>
            ${review.verifiedPurchase ? '<span class="verified-badge"><i class="fas fa-check"></i> Verified</span>' : ''}
            <div class="stars">${formatStars(review.rating)}</div>
            <div class="meta">${new Date(review.createdAt).toLocaleDateString()} ${review.status === 'flagged' ? '‚Ä¢ <span style="color:red">Flagged</span>' : ''}</div>
          </div>
          <div>
            <span class="small muted"><i class="fas fa-thumbs-up"></i> ${review.helpfulCount || 0}</span>
          </div>
        </div>
        <div style="margin-top:8px">${escapeHtml(review.body)}</div>
        ${mediaHtml}
        ${repliesHtml}
        <div style="margin-top:10px">
          <button class="btn ghost" onclick="editReview('${review.id}')"><i class="fas fa-edit"></i> Edit</button>
          <button class="btn ghost" onclick="deleteReview('${review.id}')"><i class="fas fa-trash"></i> Delete</button>
        </div>
      </div>
    `;

    container.appendChild(div);
  });
}

// ==============================================
// UPDATE SUMMARY
// ==============================================
function updateSummary() {
  const total = allReviews.length;
  const avg = total > 0 ? (allReviews.reduce((sum, r) => sum + r.rating, 0) / total).toFixed(1) : 0;

  document.getElementById('avgRating').textContent = avg;
  document.getElementById('totalReviews').textContent = `${total} review${total !== 1 ? 's' : ''}`;
}

// ==============================================
// DELETE REVIEW
// ==============================================
async function deleteReview(reviewId) {
  if (!confirm('Delete this review? This action cannot be undone.')) return;

  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_BASE_URL}/reviews/${reviewId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    const data = await response.json();

    if (response.ok && data.status === 'success') {
      showToast('Review deleted successfully');
      loadMyReviews(); // Reload
    } else {
      throw new Error(data.message || 'Failed to delete review');
    }
  } catch (error) {
    console.error('Delete error:', error);
    showToast(error.message || 'Failed to delete review', 'error');
  }
}

// ==============================================
// EDIT REVIEW (Placeholder - implement as needed)
// ==============================================
function editReview(reviewId) {
  showToast('Edit feature coming soon! Review ID: ' + reviewId, 'error');
  // TODO: Implement edit form
}

// ==============================================
// WRITE NEW REVIEW (Placeholder)
// ==============================================
function showWriteReviewForm() {
  showToast('Write review form coming soon!', 'error');
  // TODO: Implement write review form
  // Should allow selecting a purchased product and writing review
}

// ==============================================
// EVENT LISTENERS
// ==============================================
document.addEventListener('DOMContentLoaded', () => {
  loadMyReviews();

  document.getElementById('sortBy').addEventListener('change', renderReviews);
  document.getElementById('filterStar').addEventListener('change', renderReviews);
  document.getElementById('searchQuery').addEventListener('input', () => {
    setTimeout(renderReviews, 300); // Debounce
  });
  document.getElementById('clearFilters').addEventListener('click', () => {
    document.getElementById('sortBy').value = 'newest';
    document.getElementById('filterStar').value = '';
    document.getElementById('searchQuery').value = '';
    renderReviews();
  });
});
</script>

</body>
</html>