<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Purchase History - MarketMix</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: #FFF7ED;
    color: #333;
  }

  .container {
    max-width: 1200px;
    margin: auto;
    padding: 20px;
  }

  h2 {
    text-align: center;
    margin-bottom: 20px;
  }

  /* Loading Spinner */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #F97316;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Insights Dashboard */
  .dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
  }

  .card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    text-align: center;
  }
  .card h3 {
    margin: 5px 0;
    font-size: 1.4em;
  }
  .card p {
    margin: 0;
    color: #777;
  }
  
  @media (max-width: 768px) {
    .dashboard {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
  }

  /* Search and filter bar */
  .search-filter {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
  }
  .search-filter input,
  .search-filter select {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    flex: 1;
    min-width: 150px;
  }
  .search-filter button {
    background: #F97316; 
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
  }
  .search-filter button:hover {
    background: #EA580C;
  }

  /* Pagination */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
  }
  .pagination button {
    background: #F97316;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
  }
  .pagination button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  .pagination span {
    font-weight: 600;
  }

  /* Table styles */
  .history-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    border-radius: 8px;
    overflow: hidden;
  }
  .history-table th,
  .history-table td {
    padding: 14px 16px;
    text-align: left;
    vertical-align: middle;
  }
  .history-table th {
    background-color: #F97316; 
    color: white;
    font-weight: bold;
  }
  .history-table tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  .history-table td img {
    width: 40px;
    height: 40px;
    border-radius: 4px;
    object-fit: cover;
    margin-right: 8px;
  }
  .product-cell {
    display: flex;
    align-items: center;
  }
  .status {
    font-weight: bold;
    text-transform: capitalize;
  }
  .status.delivered, .status.completed {
    color: green;
  }
  .status.cancelled {
    color: red;
  }
  .status.pending, .status.processing {
    color: orange;
  }
  .status.shipped {
    color: blue;
  }
  
  .drop-review-inline-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 8px;
    background: #f97316;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8em;
  }
  .drop-review-inline-btn:hover {
    background: #EA580C;
  }
  .drop-review-inline-btn[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .product-list-inline { 
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .product-name { 
    font-weight:600; 
    margin-right:8px;
  }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: #666;
  }

  .error-message {
    background: #fee;
    color: #c00;
    padding: 15px;
    border-radius: 8px;
    margin: 20px 0;
    text-align: center;
  }

  /* Notification Center */
  .notifications {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 250px;
    max-height: 80vh;
    overflow-y: auto;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    display: none;
    flex-direction: column;
    z-index: 999;
  }
  .notification {
    padding: 10px;
    border-bottom: 1px solid #eee;
    font-size: 0.9em;
  }

  /* Mobile responsive table */
  @media (max-width: 768px) {
    .history-table thead { display: none; }
    .history-table tr {
      display: block;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    .history-table td {
      display: block;
      text-align: right;
      position: relative;
      padding-left: 50%;
    }
    .history-table td::before {
      content: attr(data-label);
      position: absolute;
      left: 10px;
      font-weight: bold;
    }
  }

  footer {
    background: rgba(0, 0, 0, 0.7);
    color: #f8fafc;
    text-align: center;
    padding: 25px 15px;
    margin-top: 60px;
    font-size: 15px;
  }

  .back-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #F97316;
    color: #fff;
    border: none;
    padding: 10px 16px;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
    margin: 2px;
    transition: 0.3s;
  }

  .back-btn i {
    font-size: 18px;
  }

  .back-btn:hover {
    background: #EA580C;
    transform: translateY(-2px);
  }
</style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
</div>

<button class="back-btn" onclick="history.back()">
  <i class="fas fa-chevron-left"></i> Back
</button>

<div class="container">
  <h2>ðŸ§¾ Purchase History</h2>

  <!-- Dashboard -->
  <div class="dashboard">
    <div class="card">
      <h3 id="totalSpent">$0.00</h3>
      <p>Total Spent</p>
    </div>
    <div class="card">
      <h3 id="totalOrders">0</h3>
      <p>Total Orders</p>
    </div>
    <div class="card">
      <h3 id="deliveredOrders">0</h3>
      <p>Delivered Orders</p>
    </div>
    <div class="card">
      <h3 id="pendingOrders">0</h3>
      <p>Pending Orders</p>
    </div>
  </div>

  <!-- Error Message -->
  <div id="errorMessage" class="error-message" style="display:none;"></div>

  <!-- Search and filter -->
  <div class="search-filter">
    <input type="text" id="searchInput" placeholder="Search by product or order ID...">
    <select id="statusFilter">
      <option value="">All Statuses</option>
      <option value="pending">Pending</option>
      <option value="processing">Processing</option>
      <option value="shipped">Shipped</option>
      <option value="delivered">Delivered</option>
      <option value="completed">Completed</option>
      <option value="cancelled">Cancelled</option>
    </select>
    <button onclick="applyFilters()">Apply Filters</button>
  </div>

  <!-- Purchase history table -->
  <table class="history-table" id="orderTable">
    <thead>
      <tr>
        <th>Order ID</th>
        <th>Date</th>
        <th>Total item</th>
        <th>Total Amount</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="orderTableBody">
      <!-- Orders will be loaded dynamically -->
    </tbody>
  </table>

  <!-- Empty State -->
  <div id="emptyState" class="empty-state" style="display:none;">
    <i class="fas fa-shopping-bag" style="font-size: 48px; color: #ccc;"></i>
    <p>No orders found</p>
  </div>

  <!-- Pagination -->
  <div class="pagination" id="pagination" style="display:none;">
    <button id="prevBtn" onclick="changePage(-1)">
      <i class="fas fa-chevron-left"></i> Previous
    </button>
    <span id="pageInfo">Page 1 of 1</span>
    <button id="nextBtn" onclick="changePage(1)">
      Next <i class="fas fa-chevron-right"></i>
    </button>
  </div>
</div>

<!-- Notification Center -->
<div class="notifications" id="notificationCenter"></div>

<script>
const API_BASE_URL = 'https://marketmix-backend.onrender.com';
let currentPage = 1;
let totalPages = 1;
let currentFilters = {
  search: '',
  status: ''
};

// Optional Supabase configuration: set in localStorage or window.SUPABASE_CONFIG
// Example: localStorage.setItem('SUPABASE_URL', 'https://xyz.supabase.co');
//          localStorage.setItem('SUPABASE_KEY', 'anon-or-service-key');
function getSupabaseConfig() {
  try {
    if (window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.url && window.SUPABASE_CONFIG.key) {
      return { url: window.SUPABASE_CONFIG.url, key: window.SUPABASE_CONFIG.key };
    }
    const url = localStorage.getItem('SUPABASE_URL');
    const key = localStorage.getItem('SUPABASE_KEY');
    if (url && key) return { url, key };
  } catch (e) {
    // ignore
  }
  return null;
}

// Fetch orders directly from Supabase order_details table when config is available.
// Falls back to backend API when supabase config is not set or request fails.
async function fetchOrdersFromSupabase(buyerId) {
  const cfg = getSupabaseConfig();
  if (!cfg) return null;

  try {
    // Fetch all order_details for buyer (client-side pagination)
    const url = `${cfg.url.replace(/\/+$/,'')}/rest/v1/order_details?buyer_id=eq.${encodeURIComponent(buyerId)}&select=*&order=created_at.desc`;
    const res = await fetch(url, {
      method: 'GET',
      headers: {
        'apikey': cfg.key,
        'Authorization': `Bearer ${cfg.key}`,
        'Content-Type': 'application/json'
      }
    });

    if (!res.ok) {
      console.warn('Supabase fetch failed', res.status, await res.text());
      return null;
    }

    const rows = await res.json();
    // Map Supabase rows to the format expected by renderOrders()
    const orders = rows.map(r => ({
      id: r.order_id || r.id,
      created_at: r.created_at || r.createdAt || r.created,
      total_items: r.total_items || r.total_item_count || r.total_items_count || 0,
      total_amount: r.total_amount || r.amount || 0,
      status: r.status || 'pending',
      raw: r
    }));

    return orders;
  } catch (err) {
    console.error('Error querying Supabase order_details', err);
    return null;
  }
}

// Authentication check
function checkAuth() {
  const token = sessionStorage.getItem('token') || localStorage.getItem('token');
  if (!token) {
    window.location.replace('login for buyers.html');
    return null;
  }
  return token;
}

// Show/Hide Loading
function showLoading(show = true) {
  const overlay = document.getElementById('loadingOverlay');
  overlay.style.display = show ? 'flex' : 'none';
}

// Show notification
function notify(message, type = 'info') {
  const center = document.getElementById('notificationCenter');
  center.style.display = 'flex';
  const note = document.createElement('div');
  note.className = 'notification';
  note.style.borderLeft = type === 'error' ? '4px solid #c00' : '4px solid #F97316';
  note.innerText = message;
  center.prepend(note);
  setTimeout(() => {
    note.remove();
    if (!center.hasChildNodes()) center.style.display = 'none';
  }, 4000);
}

// Show error message
function showError(message) {
  const errorDiv = document.getElementById('errorMessage');
  errorDiv.innerText = message;
  errorDiv.style.display = 'block';
  setTimeout(() => {
    errorDiv.style.display = 'none';
  }, 5000);
}

// Format date
function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
}

// Format currency
function formatCurrency(amount) {
  return `$${parseFloat(amount).toFixed(2)}`;
}

// Load orders: prefer Supabase `order_details` when configured, otherwise fallback to backend API
async function loadOrders(page = 1) {
  const token = checkAuth();
  if (!token) return;

  showLoading(true);

  try {
    // Try Supabase first (optional). We'll paginate client-side when using Supabase.
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    const buyerId = user.id || user.user_id || user.buyer_id || user.uuid || null;
    const supabaseCfg = getSupabaseConfig();

    if (supabaseCfg && buyerId) {
      const allOrders = await fetchOrdersFromSupabase(buyerId);
      if (Array.isArray(allOrders)) {
        // Apply status filter client-side
        let filtered = allOrders;
        if (currentFilters.status) {
          filtered = filtered.filter(o => (o.status || '').toLowerCase() === currentFilters.status.toLowerCase());
        }

        // Client-side pagination
        const pageSize = 10;
        totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
        currentPage = Math.min(Math.max(1, page), totalPages);
        const start = (currentPage - 1) * pageSize;
        const pageItems = filtered.slice(start, start + pageSize);

        renderOrders(pageItems);
        updatePagination();
        updateDashboard(pageItems);
        return;
      }
      // if supabase returned null, fall through to backend
    }

    // Fallback to backend API (original behavior)
    const params = new URLSearchParams({
      page: page,
      limit: 10
    });

    if (currentFilters.status) {
      params.append('status', currentFilters.status);
    }

    const response = await fetch(`${API_BASE_URL}/api/orders?${params.toString()}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      let bodyText = '';
      try { bodyText = await response.text(); } catch (e) { /* ignore */ }
      if (response.status === 401) {
        sessionStorage.clear();
        localStorage.clear();
        window.location.replace('login for buyers.html');
        return;
      }
      throw new Error(`Failed to load orders: HTTP ${response.status} ${response.statusText} ${bodyText}`);
    }

    const data = await response.json();
    if (data.success) {
      const orders = data.data.orders || [];
      const pagination = data.data.pagination || {};

      currentPage = pagination.currentPage || 1;
      totalPages = pagination.totalPages || 1;

      renderOrders(orders);
      updatePagination();
      updateDashboard(orders);
    } else {
      throw new Error(data.message || 'Failed to load orders');
    }

  } catch (error) {
    console.error('Error loading orders:', error);
    showError('Failed to load purchase history. Please try again.');
  } finally {
    showLoading(false);
  }
}

// Update dashboard statistics
function updateDashboard(orders) {
  // Calculate totals from current page orders
  const totalSpent = orders.reduce((sum, order) => sum + parseFloat(order.total_amount || 0), 0);
  const totalCount = orders.length;
  const deliveredCount = orders.filter(o => 
    o.status === 'delivered' || o.status === 'completed'
  ).length;
  const pendingCount = orders.filter(o => 
    o.status === 'pending' || o.status === 'processing'
  ).length;

  document.getElementById('totalSpent').innerText = formatCurrency(totalSpent);
  document.getElementById('totalOrders').innerText = totalCount;
  document.getElementById('deliveredOrders').innerText = deliveredCount;
  document.getElementById('pendingOrders').innerText = pendingCount;
}

// Render orders in table
function renderOrders(orders) {
  const tbody = document.getElementById('orderTableBody');
  const emptyState = document.getElementById('emptyState');
  
  tbody.innerHTML = '';
  
  // Apply client-side search filter if exists
  let filteredOrders = orders;
  if (currentFilters.search) {
    const searchLower = currentFilters.search.toLowerCase();
    filteredOrders = orders.filter(order => {
      const orderId = (order.id || '').toString().toLowerCase();
      const products = order.items?.map(item => 
        (item.product_name || '').toLowerCase()
      ).join(' ') || '';
      
      return orderId.includes(searchLower) || products.includes(searchLower);
    });
  }
  
  if (filteredOrders.length === 0) {
    emptyState.style.display = 'block';
    document.getElementById('orderTable').style.display = 'none';
    return;
  }
  
  emptyState.style.display = 'none';
  document.getElementById('orderTable').style.display = 'table';
  
  filteredOrders.forEach(order => {
    const row = document.createElement('tr');
    row.dataset.orderId = order.id;
    
    // Use total_items from order_details (or aggregated value from backend)
    const totalItems = order.total_items || 0;

    row.innerHTML = `
      <td data-label="Order ID">#${order.id}</td>
      <td data-label="Date">${formatDate(order.created_at)}</td>
      <td data-label="Total item">${totalItems}</td>
      <td data-label="Total Amount">${formatCurrency(order.total_amount)}</td>
      <td data-label="Status" class="status ${order.status}">${order.status}</td>
    `;
    
    tbody.appendChild(row);
  });
  
  // Add review buttons for delivered orders
  enhancePurchaseRows();
}

// Update pagination controls
function updatePagination() {
  const paginationDiv = document.getElementById('pagination');
  const pageInfo = document.getElementById('pageInfo');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  
  if (totalPages > 1) {
    paginationDiv.style.display = 'flex';
    pageInfo.innerText = `Page ${currentPage} of ${totalPages}`;
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;
  } else {
    paginationDiv.style.display = 'none';
  }
}

// Change page
function changePage(direction) {
  const newPage = currentPage + direction;
  if (newPage >= 1 && newPage <= totalPages) {
    loadOrders(newPage);
  }
}

// Apply filters
function applyFilters() {
  currentFilters.search = document.getElementById('searchInput').value.toLowerCase();
  currentFilters.status = document.getElementById('statusFilter').value;
  currentPage = 1; // Reset to first page
  loadOrders(1);
}

// Add review buttons for delivered orders
function enhancePurchaseRows() {
  const rows = document.querySelectorAll('#orderTableBody tr');
  
  rows.forEach(row => {
    const statusCell = row.querySelector('[data-label="Status"]');
    if (!statusCell) return;
    
    const statusText = statusCell.innerText.trim();
    if (statusText !== 'delivered' && statusText !== 'completed') return;

    const orderId = row.dataset.orderId || '';
    const productCell = row.querySelector('.product-cell');
    if (!productCell) return;

    const ids = (productCell.dataset.productIds || '').split(',').map(s => s.trim()).filter(Boolean);
    const names = (productCell.dataset.productNames || '').split(',').map(s => s.trim()).filter(Boolean);
    const productListDiv = productCell.querySelector('.product-list-inline');
    if (!productListDiv) return;

    // Rebuild product list with review buttons
    productListDiv.innerHTML = '';
    names.forEach((name, i) => {
      const pid = ids[i] || null;

      const itemDiv = document.createElement('div');
      itemDiv.style.display = 'flex';
      itemDiv.style.alignItems = 'center';
      itemDiv.style.justifyContent = 'space-between';
      itemDiv.style.gap = '8px';

      const nameSpan = document.createElement('span');
      nameSpan.className = 'product-name';
      nameSpan.innerText = name;
      itemDiv.appendChild(nameSpan);

      if (pid) {
        const btn = document.createElement('button');
        btn.className = 'drop-review-inline-btn';
        btn.innerHTML = '<i class="fas fa-star"></i> Review';
        btn.dataset.orderId = orderId;
        btn.dataset.productId = pid;
        btn.title = `Leave a review for ${name}`;

        btn.addEventListener('click', () => {
          window.location.href = `reviews ratings.html?product=${encodeURIComponent(pid)}&order=${encodeURIComponent(orderId)}`;
        });

        itemDiv.appendChild(btn);
      }

      productListDiv.appendChild(itemDiv);
    });
  });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
  loadOrders(1);
  
  // Add event listeners for real-time search
  document.getElementById('searchInput').addEventListener('keyup', (e) => {
    if (e.key === 'Enter') {
      applyFilters();
    }
  });
});
</script>

<footer>
  Â© MarketMix 2025
</footer>

</body>
</html>