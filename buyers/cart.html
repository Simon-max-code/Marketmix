<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cart - MarketMix</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
   <!-- ðŸ”’ BLOCK UNAUTHORIZED USERS -->
  
  <style>
    :root{
      --bg:#fff7ed;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --accent: #F97316;     
      --accent-600:#EA580C; 
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .cart-container{
      max-width: 960px;
      margin: 32px auto;
      padding: 0 16px;
    }

    h1{
      margin: 0 0 16px;
      font-size: clamp(1.5rem, 2.5vw, 2rem);
      font-weight: 700;
      letter-spacing: .2px;
      color: var(--text);
    }

    .intro{
      margin: 0 0 20px;
      color: var(--muted);
      font-size: .95rem;
    }

    .cart-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:16px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--card);
      margin-bottom:12px;
    }

    .item-details h3{
      margin:0;
      font-size:1rem;
      font-weight:600;
      color:var(--text);
    }
    .item-details p{
      margin:.35rem 0 0;
      font-size:.95rem;
      color:var(--muted);
    }

    .item-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .quantity-btn{
      width:36px;height:36px;line-height:36px;
      border:none;border-radius:8px;
      background:var(--accent);color:#fff;
      font-size:1.1rem;font-weight:700;
      cursor:pointer;
      transition: background .15s ease;
    }
    .quantity-btn:hover{ background: var(--accent-600); }
    .quantity{ min-width:24px; text-align:center; font-weight:600; }

    .delete-btn{
      border:1px solid var(--danger);
      color:var(--danger);
      background:#fff;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      transition: all .15s ease;
    }
    .delete-btn:hover{
      background:var(--danger);
      color:#fff;
    }

    .totals-card{
      margin-top:16px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .total{
      font-size:1.15rem;
      font-weight:700;
      color:var(--accent);
    }

    .actions{
      display:flex;
      gap:10px;
      width:100%;
    }
    @media (min-width:600px){
      .actions{ width:auto; margin-left:auto; }
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:12px 16px; border-radius:10px; border:1px solid transparent;
      font-weight:600; cursor:pointer; text-decoration:none;
      transition: background .15s ease, border-color .15s ease, color .15s ease;
      white-space:nowrap;
    }
    .btn-primary{
      background:var(--accent); color:#fff;
    }
    .btn-primary:hover{ background:var(--accent-600); }
    .btn-outline{
      background:#fff; color:var(--accent); border-color:var(--accent);
    }
    .btn-outline:hover{
      background: #eef2ff; border-color: var(--accent-600); color: var(--accent-600);
    }

    /* Responsive layout tweaks */
    @media (max-width:680px){
      .cart-item{ align-items:flex-start; }
      .item-actions{ margin-left:auto; }
    }

    /* Mobile optimization */
    @media (max-width: 480px) {
      body { font-size: 15px; }
      h1 { font-size: 1.3rem; margin-bottom: 12px; }
      .cart-container { margin: 16px auto; padding: 0 12px; }
      .cart-item { flex-direction: column; align-items: flex-start; gap: 12px; padding: 12px; }
      .item-details h3 { font-size: 1rem; }
      .item-details p { font-size: 0.9rem; }
      .item-actions { width: 100%; justify-content: space-between; margin-top: 8px; }
      .quantity-btn { width: 40px; height: 40px; font-size: 1.2rem; }
      .delete-btn { flex: 1; text-align: center; padding: 10px; font-size: 0.9rem; }
      .totals-card { flex-direction: column; align-items: flex-start; gap: 16px; padding: 14px; }
      .total { font-size: 1rem; }
      .actions { flex-direction: column; width: 100%; gap: 8px; }
      .btn { width: 100%; font-size: 0.95rem; padding: 12px; }
    }

    .back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #F97316;
      color: #000;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: 0.3s;
    }
    .back i { font-size: 18px; }
    .back:hover { background: #EA580C; transform: translateY(-2px); }

    footer {
      background: rgba(0, 0, 0, 0.7);
      color: #f8fafc;
      text-align: center;
      padding: 25px 15px;
      margin-top: 60px;
      font-size: 15px;
    }
  </style>
</head>
<body>

  <div class="cart-container">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div style="display:flex;align-items:center;gap:12px">
        <button class="back" onclick="history.back()">
      <i class="fas fa-chevron-left"></i> Back
    </button>
      </div>

      <!-- Recent Deleted button -->
      <div style="display:flex;align-items:center;gap:8px">
        <button id="recentDeletedBtn" title="Recent deleted products" style="background:#fff;border:1px solid #f97316;color:#f97316;padding:8px 12px;border-radius:10px;cursor:pointer;display:flex;align-items:center;gap:8px">
          <i class="fas fa-trash-restore"></i>
          <span id="recentDeletedLabel">Recent deleted</span>
          <span id="recentDeletedCount" style="background:#f97316;color:#fff;padding:2px 8px;border-radius:999px;font-weight:700;display:inline-block;min-width:20px;text-align:center">0</span>
        </button>
      </div>
    </div>

    <h1>Your Cart</h1>
    <p class="intro">Review your items, adjust quantities, or remove products before checkout.</p>

    <!-- Cart items injected here -->
    <div id="cart-items"></div>

    <!-- Totals + actions -->
    <div class="totals-card">
      <div class="total">Total: $0.00</div>
      <div class="actions">
        <a href="checkout.html" id="proceedCheckout" class="btn btn-primary">Proceed to Checkout</a>
        <a href="reviews ratings.html" class="btn btn-outline">Go to Reviews & Ratings</a>
      </div>
    </div>
  </div>

  <footer>
    &copy; 2025 MarketMix. All Rights Reserved.
  </footer>
  <script src="config.js"></script>
  <script>
    // Cart + Recent-Deleted script

    const CART_KEY = (CONFIG && CONFIG.STORAGE_KEYS && CONFIG.STORAGE_KEYS.CART) ? CONFIG.STORAGE_KEYS.CART : 'cart';

    let cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
    let recentDeleted = JSON.parse(localStorage.getItem('recentDeleted') || '[]');

    // Recent-deleted TTL (5 days)
    const RECENT_DELETED_TTL_MS = 5 * 24 * 60 * 60 * 1000; // 5 days in milliseconds

    function pruneRecentDeleted() {
      try {
        const now = Date.now();
        recentDeleted = (recentDeleted || []).filter(item => {
          if (!item || !item.deletedAt) return false;
          const t = new Date(item.deletedAt).getTime();
          if (isNaN(t)) return false;
          return (now - t) < RECENT_DELETED_TTL_MS;
        });
      } catch (e) {
        console.warn('pruneRecentDeleted failed', e);
        recentDeleted = [];
      }
    }

    function updateCartCount() {
      const count = cart.reduce((sum, item) => sum + (item.quantity||0), 0);
      const cartCount = document.querySelector('.cart-count');
      if(cartCount){
        cartCount.textContent = count;
        cartCount.style.display = count > 0 ? 'inline-block' : 'none';
      }
    }

    function saveCart() {
      try { localStorage.setItem(CART_KEY, JSON.stringify(cart)); } catch(e){}
      updateCartCount();
    }

    function saveRecentDeleted() {
      try { 
        pruneRecentDeleted();
        localStorage.setItem('recentDeleted', JSON.stringify(recentDeleted.slice(0,20))); 
      } catch(e){}
      updateRecentDeletedBadge();
    }

    function updateRecentDeletedBadge(){
      const el = document.getElementById('recentDeletedCount');
      if(!el) return;
      pruneRecentDeleted();
      el.textContent = String(recentDeleted.length || 0);
      el.style.display = recentDeleted.length ? 'inline-block' : 'none';
    }

    // Render functions
    function renderCart(){
      const container = document.getElementById('cart-items');
      container.innerHTML = '';
      if(!cart || cart.length === 0){
        container.innerHTML = '<p>Your cart is empty.</p>';
        updateTotal();
        return;
      }

      cart.forEach((item, index) => {
        const div = document.createElement('div');
        div.classList.add('cart-item');
        div.innerHTML = `
          <div class="item-details">
            <h3>${item.name}</h3>
            <p>$${parseFloat(item.price).toFixed(2)}</p>
          </div>
          <div class="item-actions">
            <button class="quantity-btn">âˆ’</button>
            <span class="quantity">${item.quantity}</span>
            <button class="quantity-btn">+</button>
            <button class="delete-btn">Delete</button>
          </div>
        `;

        const [minusBtn, quantitySpan, plusBtn, deleteBtn] = div.querySelectorAll('.item-actions *');

        minusBtn.addEventListener('click', async ()=>{
          if(item.quantity > 1){ 
            item.quantity -= 1; 
            
            // Try backend update if item has id
            try {
              const token = (window.Auth && typeof Auth.getToken === 'function') ? Auth.getToken() : localStorage.getItem('token');
              if (item.id && token) {
                const resp = await fetch(`${CONFIG.API_BASE_URL}/cart/${item.id}`, { 
                  method: 'PUT', 
                  headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                  },
                  body: JSON.stringify({ quantity: item.quantity })
                });
                if (resp.ok) {
                  saveAndRender();
                  return;
                }
              }
            } catch(e) { console.warn('Backend update failed', e); }
            
            saveAndRender();
          }
        });

        plusBtn.addEventListener('click', async ()=>{ 
          item.quantity += 1; 
          
          // Try backend update if item has id
          try {
            const token = (window.Auth && typeof Auth.getToken === 'function') ? Auth.getToken() : localStorage.getItem('token');
            if (item.id && token) {
              const resp = await fetch(`${CONFIG.API_BASE_URL}/cart/${item.id}`, { 
                method: 'PUT', 
                headers: { 
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify({ quantity: item.quantity })
              });
              if (resp.ok) {
                saveAndRender();
                return;
              }
            }
          } catch(e) { console.warn('Backend update failed', e); }
          
          saveAndRender();
        });

        deleteBtn.addEventListener('click', async ()=>{
          // push deleted item into recentDeleted (store a small snapshot)
          try{
            const snapshot = {
              // cart item id (backend cart_items id) if present
              cartItemId: item.id || null,
              // product id (the actual product's id) if present
              productId: item.productId || item.product_id || null,
              name: item.name,
              price: item.price,
              image: item.image || '',
              quantity: item.quantity || 1,
              deletedAt: new Date().toISOString()
            };
            recentDeleted.push(snapshot);
            // keep only last 20
            if(recentDeleted.length > 20) recentDeleted = recentDeleted.slice(-20);
            saveRecentDeleted();
          } catch(e){ console.warn('Recent delete save failed', e); }

          // Try backend deletion if item has id
          try {
            const token = (window.Auth && typeof Auth.getToken === 'function') ? Auth.getToken() : localStorage.getItem('token');
            if (item.id && token) {
              const resp = await fetch(`${CONFIG.API_BASE_URL}/cart/${item.id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
              if (resp.ok) {
                cart.splice(index,1);
                saveAndRender();
                return;
              }
            }
          } catch(e) { console.warn('Backend delete failed', e); }

          // fallback local remove
          cart.splice(index,1);
          saveAndRender();
        });

        container.appendChild(div);
      });

      updateTotal();
    }

    function updateTotal(){
      const totalEl = document.querySelector('.total');
      const total = cart.reduce((sum, item) => sum + Number(item.price||0) * Number(item.quantity||0), 0);
      if(totalEl) totalEl.textContent = `Total: $${total.toFixed(2)}`;
    }

    function saveAndRender(){ saveCart(); renderCart(); }

    // Recent deleted overlay functions
    function openRecentDeleted(){ const over = document.getElementById('recentDeletedOverlay'); if(!over) return; over.style.display='flex'; renderRecentDeleted(); }
    function closeRecentDeleted(){ const over = document.getElementById('recentDeletedOverlay'); if(!over) return; over.style.display='none'; }

    function renderRecentDeleted(){
      const container = document.getElementById('recentDeletedList'); if(!container) return;
      container.innerHTML = '';
      if(!recentDeleted || recentDeleted.length===0){ container.innerHTML = '<p style="color:#64748b">No recently deleted items.</p>'; return; }
      recentDeleted.slice().reverse().forEach((it, idx)=>{
        const div = document.createElement('div');
        div.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f1f5f9';
        div.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center">
            <img src="${it.image||''}" style="width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid #e6e9ef">
            <div>
              <div style="font-weight:700">${it.name||''}</div>
              <div style="color:#64748b">$${Number(it.price||0).toFixed(2)} &middot; qty ${it.quantity||1}</div>
            </div>
          </div>
          <div>
            <button class="restore-btn" data-idx="${idx}" style="background:#f97316;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer">Restore</button>
          </div>
        `;
        container.appendChild(div);
      });
      container.querySelectorAll('.restore-btn').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const idx = Number(btn.getAttribute('data-idx'));
          const actualIndex = recentDeleted.length - 1 - idx;
          const item = recentDeleted[actualIndex];
          if(!item) return;
          
          const token = (window.Auth && typeof Auth.getToken === 'function') ? Auth.getToken() : localStorage.getItem('token');
          
          // If user is logged in, call backend API
          if(token && item.productId) {
            try {
              // debug: show what we're sending
              console.log('Restore: POST', `${CONFIG.API_BASE_URL}/cart/add`, { product_id: item.productId, quantity: item.quantity || 1 });
              const response = await fetch(`${CONFIG.API_BASE_URL}/cart/add`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                  product_id: item.productId,
                  quantity: item.quantity || 1
                })
              });
              
              if(!response.ok) {
                const errorData = await response.json().catch(()=>({}));
                console.warn('Restore failed:', errorData);
                // Fallback: restore locally if backend cannot restore (product missing/inactive)
                const existingLocal = cart.find(c=>c.productId === item.productId || c.name === item.name);
                if (existingLocal) existingLocal.quantity = (existingLocal.quantity||0) + (item.quantity||1);
                else cart.push({
                  // don't have backend id, store productId so future ops can reference product
                  productId: item.productId || null,
                  name: item.name,
                  price: item.price,
                  quantity: item.quantity || 1,
                  image: item.image || ''
                });
                // remove from recentDeleted and save
                recentDeleted.splice(actualIndex, 1);
                saveRecentDeleted();
                saveAndRender();
                renderRecentDeleted();
                showMessage('Restored locally (product unavailable on server)');
                return;
              }
              
              const data = await response.json();
              console.log('Item restored from backend:', data);
              
              // remove from recentDeleted
              recentDeleted.splice(actualIndex, 1);
              saveRecentDeleted();
              
              // reload cart from backend
              await loadBackendCart();
              saveAndRender();
              renderRecentDeleted();
              showMessage('Item restored to cart');
            } catch(err) {
              console.warn('Error restoring item:', err);
              showMessage('Error restoring item');
            }
          } else {
            // Fallback to localStorage only
            const existing = cart.find(c=>c.name === item.name);
            if(existing) existing.quantity = (existing.quantity||0) + (item.quantity||1);
            else cart.push(Object.assign({}, item));
            // remove from recentDeleted
            recentDeleted.splice(actualIndex, 1);
            saveRecentDeleted();
            saveAndRender();
            renderRecentDeleted();
            showMessage('Item restored to cart');
          }
        });
      });
    }

    function showMessage(msg){ const m=document.createElement('div'); m.textContent=msg; m.style.cssText='position:fixed;bottom:90px;right:20px;background:#10b981;color:#fff;padding:10px 14px;border-radius:8px;z-index:12000'; document.body.appendChild(m); setTimeout(()=>{ m.style.opacity='0'; setTimeout(()=>m.remove(),300); },1400); }

    // Load cart from backend for authenticated users
    async function loadBackendCart() {
      try {
        const token = (window.Auth && typeof Auth.getToken === 'function') ? Auth.getToken() : localStorage.getItem('token');
        if (!token) return false;

        const resp = await fetch(`${CONFIG.API_BASE_URL}/cart`, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!resp.ok) return false;

        const payload = await resp.json().catch(()=>null);
        if (!payload || !payload.data || !Array.isArray(payload.data.items)) return false;

        // Map backend items into local `cart` shape (ensure we keep backend cart item `id`)
        cart = payload.data.items.map(it => ({
          id: it.id,
          productId: it.productId || it.product_id,
          name: it.name || it.productName || '',
          price: it.price || it.unitPrice || 0,
          quantity: it.quantity || 1,
          image: it.image || it.main_image_url || ''
        }));

        saveAndRender();
        return true;
      } catch (err) {
        console.warn('loadBackendCart failed', err);
        return false;
      }
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', async ()=>{
      // wire recent button
      const btn = document.getElementById('recentDeletedBtn'); if(btn) btn.addEventListener('click', openRecentDeleted);
      // prune expired recentDeleted items on initial load and persist
      try { pruneRecentDeleted(); localStorage.setItem('recentDeleted', JSON.stringify(recentDeleted.slice(0,20))); } catch(e){}
      updateRecentDeletedBadge();

      // If user is authenticated, try to load cart from backend (this will call saveAndRender())
      const token = (window.Auth && typeof Auth.getToken === 'function') ? Auth.getToken() : localStorage.getItem('token');
      const loaded = token ? await loadBackendCart().catch(()=>false) : false;
      if (!loaded) {
        // fallback to local storage cart
        renderCart();
        updateCartCount();
      }

      // wire proceed to checkout (keep existing gate behavior if present)
      const proceed = document.getElementById('proceedCheckout');
      if(proceed){
        proceed.addEventListener('click', async (e)=>{
          try{ e.preventDefault();
            const _params = new URLSearchParams(window.location.search || '');
            const _forceLogin = _params.get('force_login') === '1';
            let token = (window.Auth && typeof Auth.getToken === 'function') ? Auth.getToken() : localStorage.getItem('token');
            if(_forceLogin) token = null;
            if(!token){ localStorage.setItem('after_login_redirect','/buyers/checkout.html'); window.location.href = '/buyers/login for buyers.html?next=checkout.html'; return false; }
            // simple proceed
            window.location.href = 'checkout.html';
            return true;
          } catch(err){ localStorage.setItem('after_login_redirect','/buyers/checkout.html'); window.location.href = '/buyers/login for buyers.html?next=checkout.html'; }
        });
      }
    });
  </script>

  <!-- Recent Deleted Overlay -->
  <div id="recentDeletedOverlay" style="position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;z-index:11000">
    <div style="position:absolute;inset:0;background:rgba(2,6,23,0.6);" onclick="closeRecentDeleted()"></div>
    <div style="width:100%;max-width:900px;background:#fff;border-radius:12px;margin:40px;padding:20px;z-index:11010;box-shadow:0 20px 60px rgba(2,6,23,0.3);">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px">
        <h3 style="margin:0">Recently deleted</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <button onclick="closeRecentDeleted()" style="background:#fff;border:1px solid #e6e9ef;padding:8px 10px;border-radius:8px;cursor:pointer">Close</button>
        </div>
      </div>
      <div id="recentDeletedList" style="max-height:60vh;overflow:auto;padding-top:6px"></div>
    </div>
  </div>

